<!DOCTYPE html>
<html>
<head>
  <title>{{ Configs.ctf_name }}</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="{{ Configs.ctf_small_icon }}" type="image/x-icon">

  {{ Plugins.styles }}

  <script type="text/javascript">
      window.init = {
          'urlRoot': "{{ request.script_root }}",
          'csrfNonce': "{{ Session.nonce }}",
          'userMode': "{{ Configs.user_mode }}",
          'userId': {{ Session.id }},
          'userName': {{ User.name | tojson }},
          'userEmail': {{ User.email | tojson }},
          'teamId': {{ Team.id | tojson }}, 
          'teamName': {{ Team.name | tojson }},
          'start': {{ Configs.start | tojson }},
          'end': {{ Configs.end | tojson }},
          'themeSettings': {{ Configs.theme_settings | tojson }},
          'eventSounds': [
            "/themes/core/static/sounds/notification.webm",
            "/themes/core/static/sounds/notification.mp3",
          ],
      }
  </script>

  {{ Configs.theme_header }}

{% block head %}
  <link rel="stylesheet prefetch" href="/themes/uiuctf-2023-ctfd-theme/static/windows-95-ui-kit/css/bootstrap.min.css">
  <link rel="stylesheet prefetch" href="/themes/uiuctf-2023-ctfd-theme/static/windows-95-ui-kit/css/w95.css">
  <script src="/themes/uiuctf-2023-ctfd-theme/static/custom/moveable.min.js"></script>
  <script src="/themes/uiuctf-2023-ctfd-theme/static/custom/marked.min.js"></script>
  <script>
    marked.use({
      mangle: false,
      headerIds: false
    });
  </script>
  <style>
    .score-graph {
      min-height: 400px;
      display: block;
      clear: both;
      background: white;
    }

    code {
      font-size: 120% !important;
      color: #2196f3 !important;
    }
    /* Moveable.js overrides */
    .item-disabled {
      cursor: not-allowed !important;
      color: #6c757d;
    }
    .moveable-line {
      height: 15px !important;
      opacity: 0 !important;
    }
    .moveable-control {
      opacity: 0 !important;
    }

    body {
      overflow: hidden;
    }

     /* Disable image dragging */
    img {
      -webkit-user-drag: none;
      -khtml-user-drag: none;
      -moz-user-drag: none;
      -o-user-drag: none;
      user-drag: none;
      image-rendering: pixelated;
      pointer-events: none;
    }

    .taskbar {
      z-index: 2000;
    }

    .taskbar-button {
      margin-right: 3px;
      width: 160px;
      min-width: 32px;
    }

    .start-button {
      margin-right: 4px !important;
    }

    .start-menu-container {
      position: absolute;
      height: 238px;
      width: 164px;
    }

    .start-menu {
      position: relative;
      top: -100%;
      height: 100%;
      width: 100%;
      display: flex;
      flex-flow: row;
      background-color: #c0c0c0;
      border-top: 2px solid #ffffff;
      border-left: 2px solid #ffffff;
      border-bottom: 2px solid #000000;
      border-right: 2px solid #000000;
    }

    .start-menu .logo-bar {
      background-color: #808080;
      width: 21px;
      margin-top: 1px;
      margin-left: 1px;
      margin-right: 0px;
      margin-bottom: 1px;
      padding-bottom: 7px;
      display: flex;
      justify-content: center;
      align-items: end;
      image-rendering: pixelated;
    }

    .start-menu .main-options {
      display: flex;
      flex-flow: column;
      flex-grow: 1;
      justify-content: center;
    }

    .pe-none {
      pointer-events: none !important;
    }
    .start-menu .main-options > div {
      display: flex;
      flex-flow: row;
      flex-grow: 1;
      align-items: center;
      padding-left: 10px;
      padding-right: 7px;
    }

    .start-menu .main-options > div:hover {
      background-color: #000080;
      color: #ffffff;
    }

    .start-menu .main-options img {
      height: 26px;
      margin-right: 10px;
    }

    .pane {
      overflow-x: hidden;
      overflow-y: hidden;
      position: absolute;
      top: 0;
      left: 0;
      min-width: 128px;
      min-height: 64px;
    }

    .card-header-content {
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      user-select: none;
    }

    .card-body {
      max-height: 100%;
      overflow-y: auto;
    }

    .pane-control-icon, .btn-close {
      image-rendering: pixelated;
      user-select: none;
    }
    .pane-control-icon > img, .btn-close > img {
      pointer-events: none;
      display: none;
      height: 0.875rem;
    }
    .pane-control-icon > img:first-child, .btn-close > img:first-child {
      display: block;
    }
    .pane-control-icon:active > img:first-child, .btn-close:active > img:first-child {
      display: none;
    }
    .pane-control-icon:active > img:last-child, .btn-close:active > img:last-child {
      display: block;
    }
    .close-icon, .btn-close {
      margin-left: 0.125rem;
    }

    .user-select-none {
      user-select: none !important;
    }

    button.btn-close {
      border-color: transparent !important;
      border-width: 0px !important;
      padding: 0px !important;
    }

    .info-panel {
      background: #feffd1;
      overflow: auto;
    }

    .modal-backdrop {
      z-index: -1; /* no more unclicky */
    }
  </style>

  <script type="text/javascript">
    async function unlockHint(hint_id) {
      let unlock = await CTFd.pages.challenge.loadUnlock(hint_id);
      if (unlock.success) {
        desktop.createAlertPane({
          title: "Hint Unlocked",
          content: "Please close and reopen the challenge to view your hint.",
          type: "info"
        });
      } else {
        desktop.createAlertPane({
          title: "Hint Unlock Error",
          content: "You have insufficient points to unlock this hint."
        });
      }
    }
    function timer() {
      return {
        expiry_end: null,
        expiry_start: null,
        remaining:null,
        init() {
          this.expiry_end = window.init.end ? window.init.end * 1000 : null;
          this.expiry_start = window.init.start ? window.init.start * 1000 : null;
          this.setRemaining()
          setInterval(() => {
            this.setRemaining();
          }, 1000);
        },
        setRemaining() {
          // we want a countdown to end if we have already started
          const now = new Date().getTime();
          const expiry = (this.expiry_start === null || now > this.expiry_start) ? this.expiry_end : this.expiry_start;
          
          const past_expiry = expiry < now;
          const diff = (past_expiry) ? now - expiry : expiry - now;
          this.remaining = parseInt(diff / 1000);
        },
        days() {
          return {
            value: this.remaining / 86400,
            remaining:this.remaining % 86400
          };
        },
        hours() {
          return {
            value:this.days().remaining / 3600,
            remaining:this.days().remaining % 3600
          };
        },
        minutes() {
          return {
            value:this.hours().remaining / 60,
            remaining:this.hours().remaining % 60
          };
        },
        seconds() {
          return {
            value: this.minutes().remaining,
          };
        },
        format(value) {
          return ("0" + parseInt(value)).slice(-2)
        },
        time(){
          return {
            days:this.format(this.days().value),
            hours:this.format(this.hours().value),
            minutes:this.format(this.minutes().value),
            seconds:this.format(this.seconds().value),
            text: this.isCountdown ? "left" : ""
          }
        },
      }
    }

    document.addEventListener('alpine:init', () => {
      Alpine.store('globals', {
            user: null,
            show_start: true
      })
      Alpine.data('desktop', () => ({
        init() {
          // TODO: Move classes into a separate JS file
          // TODO: Initial window start (brand new session)
          class Pane {
            constructor(params) {
              // Check required parameters
              if (!params.name) throw new Error("Pane must have a name");
              if (!params.desktop) throw new Error("Pane must be linked to a Desktop");
              if (!params.title) throw new Error("Pane must have a title");
              if (!params.initial_body_elem) throw new Error("Pane must have initial body element");
              this.name = params.name;
              this.desktop = params.desktop;
              this.title = params.title;
              this.recreate = params.recreate ?? null;
              this.taskbar_title = params.taskbar_title ?? params.title;
              this.initial_body_elem = params.initial_body_elem;
              this.icon_path = params.icon_path ?? null;
              this.hide_minimize = params.hide_minimize ?? false;
              this.hide_maximize = params.hide_maximize ?? false;
              this.hide_close = params.hide_close ?? false;
              this.disable_drag = params.disable_drag ?? false;
              this.disable_resize = params.disable_resize ?? false;
              this.disable_padding = params.disable_padding ?? false;
              this.#createPaneDOM();

              // Dynamic attributes
              this.transform = params.transform ?? `translate(${params.x ?? 0}px, ${params.y ?? 0}px)`;
              this.z = params.z ?? 0;
              this.width = params.width ?? null;
              this.height = params.height ?? null;
              this.minimized = params.minimized ?? false;
              this.maximized = params.maximized ?? false;
              this.focused = params.focused ?? false;
              this.id = params.id;
              this.content = params.content;
              this.PANE_TEAM_ID = params.PANE_TEAM_ID;
              this.PANE_USER_ID = params.PANE_USER_ID;
              this.type = params.type;
              

              this.moveable = new Moveable(document.body, {
                target: this.target,
                dragTarget: this.handle ?? null,
                // Draggable options
                draggable: !this.maximized && !this.disable_drag,
                throttleDrag: 1,
                edgeDraggable: false,
                startDragRotate: 0,
                throttleDragRotate: 0,
                edge: true,
                origin: false,
                // Resizable options
                resizable: !this.maximized && !this.disable_resize,
                throttleResize: 1,
                keepRatio: false,
                renderDirections: ["nw", "ne", "se", "sw"],
              });
              this.#registerListeners();
              this.#commitDOM();
              if (this.transform === "center") {
                const pane_w = this.width ? this.width.split("px")[0] : this.target.clientWidth;
                const pane_h = this.height ? this.height.split("px")[0] : this.target.clientHeight;
                this.transform = `translate(${(this.desktop.elem.clientWidth - pane_w) / 2}px, ${(this.desktop.elem.clientHeight - pane_h) / 2}px)`;
              }
              this.render();
            }

            #createPaneDOM() {
              // Ensure xref_target is unique
              let uniq, xref_target;
              do {
                uniq = Math.random().toString(16).slice(2);
                xref_target = `${this.name}_${uniq}`;
              } while (document.querySelector(`[x-ref="${xref_target}"]`));
              const xref_target_handle = `${xref_target}_handle`;
              const xref_target_taskbar_button = `${xref_target}_taskbar_button`;

              // Create pane parent
              const pane_elem = document.createElement("div");
              pane_elem.setAttribute("x-ref", xref_target);
              pane_elem.setAttribute("class", "card pane flex-column");

              // Create handle
              const pane_handle = document.createElement("div");
              pane_handle.setAttribute("x-ref", xref_target_handle);
              pane_handle.setAttribute("class", "card-header d-flex flex-row justify-content-between align-items-center");
              const pane_title = document.createElement("div");
              pane_title.setAttribute("class", "card-header-content");
              // TODO: Icon
              pane_title.appendChild(document.createTextNode(this.title));
              pane_handle.appendChild(pane_title);

              // Create pane controls
              const pane_controls = document.createElement("div");
              pane_controls.setAttribute("class", "d-flex flex-row");
              if (!this.hide_minimize) {
                pane_controls.insertAdjacentHTML("beforeend", `
                  <div class="pane-control-icon" x-ref="minimize">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/minimize.png">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/minimize_pressed.png">
                  </div>
                `)
              }
              if (!this.hide_maximize) {
                pane_controls.insertAdjacentHTML("beforeend", `
                  <span x-ref="maximize-restore-group">
                    <div class="pane-control-icon" x-ref="maximize">
                      <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/maximize.png" alt="">
                      <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/maximize_pressed.png" alt="">
                    </div>
                    <div class="pane-control-icon" x-ref="restore">
                      <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/restore.png" alt="">
                      <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/restore_pressed.png" alt="">
                    </div>
                  </span>
                `)
              }
              if (!this.hide_close) {
                pane_controls.insertAdjacentHTML("beforeend", `
                  <div class="pane-control-icon close-icon" x-ref="close">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close.png" alt="">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close_pressed.png" alt="">
                  </div>
                `)
              }
              pane_handle.appendChild(pane_controls);
              pane_elem.appendChild(pane_handle);

              // Create pane body
              const pane_body = document.createElement("div");
              pane_body.setAttribute("class", "card-body");
              if (this.disable_padding) pane_body.classList.add("p-0");
              pane_body.insertAdjacentHTML("beforeend", this.initial_body_elem);
              pane_elem.appendChild(pane_body);

              // Create taskbar button
              const taskbar_button = document.createElement("li");
              taskbar_button.setAttribute("class", "nav-item taskbar-button");
              const taskbar_button_link = document.createElement("a");
              taskbar_button_link.setAttribute("x-ref", xref_target_taskbar_button);
              taskbar_button_link.setAttribute("class", "nav-link d-flex flex-row");
              taskbar_button_link.setAttribute("role", "button");
              const taskbar_button_icon = document.createElement("img");
              taskbar_button_icon.setAttribute("class", "taskbar-icon");
              if (this.icon_path) taskbar_button_icon.setAttribute("src", this.icon_path);
              const taskbar_button_text = document.createElement("div");
              taskbar_button_text.innerText = this.taskbar_title;
              taskbar_button_link.appendChild(taskbar_button_icon);
              taskbar_button_link.appendChild(taskbar_button_text);
              taskbar_button.appendChild(taskbar_button_link);

              // Set created elements
              this.target = pane_elem;
              this.handle = pane_handle;
              this.taskbar_button = taskbar_button_link;
            }

            /**
             * Registers event listeners for all components used to control the pane
             */
            #registerListeners() {
              this.moveable.on("drag", e => {
                e.target.style.transform = e.transform;
                if (this.maximized) this.setMaximized(false);
              });
              this.moveable.on("resize", e => {
                e.target.style.transform = e.transform;
                e.target.style.width = `${e.width}px`;
                e.target.style.height = `${e.height}px`;
                // Call window resize event
                // TODO: optimize
                window.dispatchEvent(new Event("resize"));
              });
              this.moveable.on("dragStart", e => {
                this.desktop.bringToFront(this.target);
              });
              this.moveable.on("resizeStart", e => {
                this.desktop.bringToFront(this.target);
              });
              this.moveable.on("dragEnd", e => {
                if (!this.maximized) {
                  this.transform = e.target.style.transform;
                }
                this.desktop.save();
              });
              this.moveable.on("resizeEnd", e => {
                this.transform = e.target.style.transform;
                this.width = e.target.style.width;
                this.height = e.target.style.height;
                this.desktop.save();
              });
              // If any part of the pane is clicked, bring it to the front
              this.target.addEventListener("click", () => {
                this.desktop.bringToFront(this.target);
              });
              // Maximize/restore on handle double click
              this.handle.addEventListener("dblclick", () => {
                this.setMaximized(!this.maximized);
                this.render();
                this.desktop.save();
              });
              // Minimize buttons
              this.target.querySelectorAll("div[x-ref='minimize']").forEach(
                elem => elem.addEventListener("click", (event) => {
                  this.setMinimized(true);
                  event.stopImmediatePropagation();
                })
              )
              // Maximize buttons
              this.target.querySelectorAll("div[x-ref='maximize']").forEach(
                elem => elem.addEventListener("click", (event) => {
                  this.setMaximized(true);
                  event.stopImmediatePropagation();
                })
              )
              // Restore buttons
              this.target.querySelectorAll("div[x-ref='restore']").forEach(
                elem => elem.addEventListener("click", (event) => {
                  this.setMaximized(false);
                  this.desktop.bringToFront(this.target);
                  event.stopImmediatePropagation();
                })
              )
              // Close buttons
              this.target.querySelectorAll("[x-ref='close']").forEach(
                elem => elem.addEventListener("click", () => {
                  this.close();
                })
              )
              // Swap maximize/restore buttons on maximize-restore-group
              this.target.querySelectorAll("[x-ref='maximize-restore-group']").forEach(
                elem => elem.addEventListener("click", () => {
                  const button_maximize = elem.querySelector("[x-ref='maximize']");
                  const button_restore = elem.querySelector("[x-ref='restore']");
                  if (this.maximized) {
                    button_maximize.style.display = "none";
                    button_restore.style.display = "block";
                  } else {
                    button_maximize.style.display = "block";
                    button_restore.style.display = "none";
                  }
                })
              )
              // Taskbar button
              if (this.taskbar_button) {
                this.taskbar_button.addEventListener("click", () => {
                  this.desktop.bringToFront(this.target);
                  this.setMinimized(false);
                })
              }
            }

            #commitDOM() {
              this.desktop.elem.appendChild(this.target);
              if (this.taskbar_button) this.desktop.taskbar.appendChild(this.taskbar_button);
            }

            #removeDOM() {
              this.desktop.elem.removeChild(this.target);
              if (this.taskbar_button) this.desktop.taskbar.removeChild(this.taskbar_button);
            }

            /**
             * Generate JSON representation of the pane's state for storing
             * @returns {object} JSON object representing the state of the pane
             */
            toJSON() {
              return {
                name: this.name,
                title: this.title,
                recreate: this.recreate,
                taskbar_title: this.taskbar_title,
                initial_body_elem: this.initial_body_elem,
                icon_path: this.icon_path,
                hide_minimize: this.hide_minimize,
                hide_maximize: this.hide_maximize,
                hide_close: this.hide_close,
                disable_drag: this.disable_drag,
                disable_resize: this.disable_resize,
                disable_padding: this.disable_padding,
                transform: this.transform,
                z: this.z,
                width: this.width,
                height: this.height,
                minimized: this.minimized,
                maximized: this.maximized,
                focused: this.focused,
                /* Pane-specific props */
                id: this.id,
                content: this.content,
                PANE_TEAM_ID: this.PANE_TEAM_ID,
                PANE_USER_ID: this.PANE_USER_ID,
                type: this.type
              }
            }

            /**
             * Closes the pane by removing its elements from the DOM and desktop state
             */
            close() {
              this.desktop.panes = this.desktop.panes.filter(p => p !== this);
              this.desktop.save();
              this.#removeDOM();
            }

            /**
             * Sets the z-index of the pane and updates the DOM
             * @param {number} value Z-index to set
             */
            setZ(value) {
              this.z = value;
              this.render();
              this.desktop.save();
            }

            /**
             * Sets the minimized state of the pane and updates the DOM
             * @param {boolean} value True if pane should be hidden, false to use previous state
             */
            setMinimized(value) {
              if (this.hide_minimize) return;
              this.minimized = value;
              if (value) this.focused = false;
              this.render();
              this.desktop.save();
            }

            /**
             * Sets the maximized state of the pane and updates the DOM
             * @param {boolean} value True if pane should be maximized, false to use previous state
             */
            setMaximized(value) {
              if (this.hide_maximize) return;
              this.maximized = value;
              this.moveable.draggable = !value && !this.disable_drag;
              this.moveable.resizable = !value && !this.disable_resize;
              this.render();
              this.desktop.save();
            }

            /**
             * Sets whether the pane is focused or not
             * @param {boolean} value True if the pane is focused, false if not
             */
            setFocused(value) {
              this.focused = value;
              this.render();
              this.desktop.save();
            }

            /**
             *  Updates the DOM to reflect the current state of the pane
             */
            render() {
              // Set z-indices of pane and moveable controls
              this.target.style.zIndex = this.z;
              this.moveable.selfElement.style.zIndex = this.z;
              // Swap maximize/restore buttons
              this.target.querySelectorAll("[x-ref='maximize-restore-group']").forEach(
                elem => {
                  const button_maximize = elem.querySelector("[x-ref='maximize']");
                  const button_restore = elem.querySelector("[x-ref='restore']");
                  if (this.maximized) {
                    button_maximize.style.display = "none";
                    button_restore.style.display = "block";
                  } else {
                    button_restore.style.display = "none";
                    button_maximize.style.display = "block";
                  }
                }
              )
              if (this.maximized) {
                this.target.style.transform = `translate(0px, 0px)`;
                this.target.style.width = "100%";
                this.target.style.height = "100%";
              } else {
                this.target.style.transform = this.transform;
                this.target.style.width = this.width;
                this.target.style.height = this.height;
              }
              if (this.minimized) {
                this.target.style.display = "none";
              } else {
                this.target.style.display = "flex";
              }
              // Set color of focused pane handle
              if (this.focused) {
                this.target.classList.add("card-tertiary");
                if (this.taskbar_button) this.taskbar_button.classList.add("pane-focused");
              } else {
                this.target.classList.remove("card-tertiary");
                if (this.taskbar_button) this.taskbar_button.classList.remove("pane-focused");
              }
              this.moveable.updateRect();
            }
          }

          class Desktop {
            constructor(params) {
              if (!params.id) throw new Error("Desktop must have an ID");
              if (!params.elem) throw new Error("Desktop must be linked to an element");
              if (!params.taskbar) throw new Error("Desktop must be linked to a taskbar");
              this.id = params.id;
              this.elem = params.elem;
              this.taskbar = params.taskbar;
              this.x_next = 30;
              this.y_next = 30;
              this.z_next = 1000;
              this.max_panes = 32;
              this.panes = [];
              // TODO
              // this.first_load = true;
              // this.user = "";
              this.restore();
              const firstLoad = localStorage.getItem(`desktop-${this.id}`) === null;
              if (firstLoad) {
                this.createInfoPane()
              }
            }

            createPane(pane_options) {
              if (this.panes.length > this.max_panes) {
                this.reset();
                return;
              }
              pane_options.desktop = this;
              pane_options.z = this.z_next;
              this.z_next += 1;
              if (!pane_options.transform && !pane_options.x && !pane_options.y) {
                pane_options.transform = `translate(${this.x_next}px, ${this.y_next}px)`;
                this.x_next += 30;
                this.y_next += 30;
                if (this.x_next > 500) this.x_next = this.x_next % 100;
                if (this.y_next > 500) this.y_next = this.y_next % 100;
              }
              // Create pane
              const pane = new Pane(pane_options);
              this.panes.push(pane);
              this.bringToFront(pane.target);
            }

            // Closes all panes matching a name
            closePanes(name) {
              const to_remove = this.panes.filter(p => p.name === name);
              if (to_remove) {
                // this.panes = this.panes.filter(p => p.name !== name);
                // this.save();
                // this.elem.removeChild(pane.target);
                // if (pane.taskbar_button) this.taskbar.removeChild(pane.taskbar_button);
                to_remove.forEach(p => p.close());
              } else {
                throw new Error(`No panes with ${name} to close`);
              }
            }

            bringToFront(pane_target) {
              const idx = this.panes.findIndex(p => p.target === pane_target);
              if (idx < 0) return;
              const pane = this.panes[idx]
              const pane_z_old = pane.z;
              // Find all panes with z-index > pane_z_old and decrement them
              this.panes.forEach(p => {
                p.setFocused(false);
                if (p.z > pane_z_old) p.setZ(p.z - 1);
              })
              // Set new active pane to top
              pane.setFocused(true);
              pane.setZ(this.z_next - 1);
            }

            markAllUnfocused() {
              this.panes.forEach(p => p.setFocused(false));
            }

            save() {
              localStorage.setItem(`desktop-${this.id}`, JSON.stringify(this.panes));
            }

            restore() {
              const saved_panes = JSON.parse(localStorage.getItem(`desktop-${this.id}`));
              if (!saved_panes) return;
              if (saved_panes.length > this.max_panes) {
                this.reset();
                return;
              }
              saved_panes.forEach(saved_pane => {
                /*
                  save arg to pane params when you call create

                  localstorage stores serialized pane

                */
                if (saved_pane.recreate) {
                  console.log('Restoring pane through JS:', saved_pane.name)
                  this[saved_pane.recreate](saved_pane)
                } else {
                  console.log('Restoring pane:', saved_pane.name)
                  this.createPane(saved_pane)
                }
              })
            }

            reset() {
              localStorage.removeItem(`desktop-${this.id}`);
              window.location.reload();
            }

            async closeAllPanes() {
              this.panes.forEach((pane) => {
                pane.close();
              });
            }

            async createAlertPane(params) {
              if (!params.title) throw new Error("Alert pane must have a title");
              if (!params.content) throw new Error("Alert pane must have content");
              const title = params.title;
              const content = params.content;
              const type = params.type ?? "alert";
              let icon_path = params.icon_path ?? "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/msg_error-0.png";
              if (type === "info") {
                icon_path = "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/msg_information-0.png";
              } else if (type === "success") {
                icon_path = "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/trust0-0.png";
              }
              const elem = `
                <div class="d-flex flex-row user-select-none">
                  <div class="m-2">
                    <img class="flex-shrink-0" src="${icon_path}">
                  </div>
                  <div class="m-2">
                    <p>
                      ${content}
                    </p>
                  </div>
                </div>
                <div class="d-flex flex-row justify-content-center">
                  <button class="btn btn-sm btn-primary" x-ref="close">
                    <span class="btn-text">OK</span>
                  </button>
                </div>
              `;
              this.createPane({
                name: "alert",
                recreate: `createAlertPane`,
                title: title,
                taskbar_title: title,
                initial_body_elem: elem,
                icon_path: icon_path,
                hide_minimize: true,
                hide_maximize: true,
                hide_close: false,
                disable_resize: true,
                transform: "center",
                ...params,
              });
            }

            createLoginPane(params) {
              const elem = `
                {% with form = Forms.auth.LoginForm() %}
                <form action="/login" method="post" accept-charset="utf-8" autocomplete="off" class="pb-2 user-select-none" @submit.prevent="desktop.doLoginForm($event)">
                  <div class="d-flex flex-row">
                    <div class="px-4 py-1">
                      <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/key_win_alt-2.png" width="64" height="64">
                    </div>
                    <div class="d-flex flex-column">
                      <p>
                        Type a user name and password to log on to UIUCTF 2023.
                      </p>
                      <div class="row">
                        <div class="col-4">
                          {{ form.name.label(class="form-label") }}
                        </div>
                        <div class="col-8">
                          <div class="w95-input-border">
                            {{ form.name(class="form-control", value=name) }}
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-4">
                          {{ form.password.label(class="form-label") }}
                        </div>
                        <div class="col-8">
                          <div class="w95-input-border">
                            {{ form.password(class="form-control", value=password) }}
                          </div>
                        </div>
                      </div>
                      <div>
                        <a class="font-xsmall" href="#" @click="desktop.createResetPasswordPane(); event.stopPropagation();">
                          Forgot your password?
                        </a>
                      </div>
                    </div>
                    <div class="d-flex flex-column pl-4">
                      <button class="btn btn-sm btn-block btn-primary" name="_submit" value="Submit">
                        <span class="btn-text">OK</span>
                      </button>
                      <button class="btn btn-sm btn-block btn-primary" disabled>
                        <span class="btn-text">Cancel</span>
                      </button>
                    </div>
                  </div>
                  {{ form.nonce() }}
                </form>
                {% endwith %}
              `;
              this.createPane({
                name: "login",
                title: "Welcome to UIUCTF 2023",
                recreate: `createLoginPane`,
                taskbar_title: "Log In",
                initial_body_elem: elem,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/key_win-1.png",
                hide_minimize: true,
                hide_maximize: true,
                hide_close: false,
                disable_resize: true,
                transform: "center",
                ...params,
              });
            }

            createInfoPane(params) {
              const elem = `
              <div class="d-flex flex-column h-100 w-100 overflow-hidden" x-data="{selected: 'about'}">
                <h5>Welcome to <b>UIUCTF 2023</b></h5>
                <div class="d-flex flex-row w-100 mt-3" style="height: calc(100% - 2.75rem);">
                  <div class="info-panel d-flex flex-column flex-grow-1 p-3 overflow-auto">
                    <template x-if="selected == 'about'">
                      <div>
                        <div class="d-flex flex-row align-items-center">
                          <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/tip.png" alt="">
                          <p class="font-weight-bold ml-2 mt-2">Did you know...</p>
                        </div>
                        <p>We have a <a href="https://discord.gg/PytGqjq" target="_blank" rel="noopener noreferrer"> Discord server!</a></p>
                        <p>Click Start > Log in... to get started.</p>
                        <p>If you do not like this theme (or need a more accessible version), you can use the stock CTFd theme <a href="/challenges" target="_blank" rel="noopener noreferrer">here</a>.</p>
                      </div>
                    </template>
                    <template x-if="selected == 'when'">
                      <div>
                        <p>
                          UIUCTF 2023 will be held Sat, 01 July 2023, 00:00 UTC — Mon, 03 July 2023, 00:00 UTC.
                        </p>
                        <!-- https://codepen.io/harsh/pen/KKdEVPV -->
                        <div x-data="timer()">
                          <h1 x-text="\`\${time().days}d:\${time().hours}h:\${time().minutes}m:\${time().seconds}s\`"></h1>
                        </div>
                      </div>
                    </template>
                    <template x-if="selected == 'prizes'">
                      <div>
                        <p>
                          As Gill Bates once said, 5.736K ought to be enough for anybody.<br>
                          That's why we are distributing exactly that much money!
                        </p>
                        <ul>
                          <li>First Place - $2048</li>
                          <li>Second Place - $1024</li>
                          <li>Third Place - $512</li>
                          <li>4th / 5th Place - $256</li>
                          <li>6th - 10th Place - $128</li>
                          <li>Writeup Prize Money - $1000</li>
                        </ul>
                      </div>
                    </template>
                    <template x-if="selected == 'sponsors'">
                      <div class="text-center">
                        <p>
                          SIGPwny thanks its UIUCTF 2023 sponsors:
                        </p>
                        <div class="d-flex flex-column align-items-center">
                          <div class="col-6 mb-2">
                            <img src="/themes/uiuctf-2023-ctfd-theme/static/img/sponsor/battelle-blue.png" class="img-fluid" alt="">
                          </div>
                          <div class="col-6 mb-2">
                            <img src="/themes/uiuctf-2023-ctfd-theme/static/img/sponsor/zellic2.png" class="img-fluid" alt="">
                          </div>
                          <div class="col-6 mb-2">
                            <img src="/themes/uiuctf-2023-ctfd-theme/static/img/sponsor/trail-of-bits.png" class="img-fluid" alt="">
                          </div>
                          <div class="col-6 mb-2">
                            <a href="https://davidan.dev"><img src="https://davidan.dev/logo.png" class="img-fluid" alt=""></a>
                          </div>
                          <div class="col-6 mb-2">
                            <img src="/themes/uiuctf-2023-ctfd-theme/static/img/sponsor/google-cloud.png" class="img-fluid" alt="">
                            <p>Infra sponsored by <a href="https://goo.gle/ctfsponsorship" target="_blank" rel="noopener noreferrer">goo.gle/ctfsponsorship</a></p>
                          </div>
                        </div>
                      </div>
                    </template>
                    <template x-if="selected == 'team'">
                      <div class="d-flex flex-column">
                        <p>Meet the UIUCTF 2023 Team!!</p>
                          <div
                            style="display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(64px, 96px));"
                            x-data="{people: [
                              { name:'Pete Stenger', img:'https://avatars.githubusercontent.com/u/13869303', href:'https://github.com/reteps' },
                              { name:'Richard Liu', img:'https://avatars.githubusercontent.com/u/9328196', href:'https://github.com/richyliu' },
                              { name:'Hassam Uddin', img:'https://avatars.githubusercontent.com/u/13320947', href:'https://hassamuddin.com' },
                              { name:'YiFei Zhu', img:'https://lh3.googleusercontent.com/a-/ACB-R5SiFvHe6qP5yi3wJVNMUQqolSc-SRIl_ncQvhC_', href:'https://github.com/zhuyifei1999' },
                              { name:'kuilin', img:'https://kuilin.net/profile_upscaled.png', href:'https://kuilin.net/' },
                              { name:'David An', img:'https://davidan.dev/dave.jpeg', href:'https://davidan.dev' },
                              { name:'Ellie Popoca', img:'https://i.imgur.com/jVsQDUP.gif', href:'https://www.linkedin.com/in/elliepopoca' },
                              { name:'Pomona Carrington-Hoekstra', img:'https://avatars.githubusercontent.com/u/86129353' },
                              { name:'George Huebner', img:'https://avatars.githubusercontent.com/u/44840644', href:'https://github.com/Feyorsh' },
                              { name:'Joseph Ravichandran', img:'https://i.imgur.com/XOk7y7X.jpg', href:'https://twitter.com/0xjprx' },
                              { name:'Minh Duong', img:'https://avatars.githubusercontent.com/u/35712968', href:'https://whitehoodhacker.net/' },
                              { name:'Anakin Dey', img:'https://avatars.githubusercontent.com/spamakin', href:'https://www.anakin-dey.com/' },
                              { name:'Nitya Sunkad', img:'https://avatars.githubusercontent.com/u/52294194?v=4', href:'https://www.linkedin.com/in/nsunkad' },
                              { name:'Anusha Ghosh', img:'https://avatars.githubusercontent.com/u/35054976' },
                              { name:'Emma Hartman', img:'https://avatars.githubusercontent.com/u/52719328?v=4', href:'https://www.linkedin.com/in/eihart123' }
                            ]}"
                            x-init="people.sort((a, b) => 0.5 - Math.random())"
                          >
                          <template x-for="person in people">
                            <div class="d-flex flex-column text-center align-items-center mx-auto">
                              <img x-bind:src="person.img" class="img-fluid" alt="">
                              <a x-bind:href="person.href">
                                <span class="font-xsmall mt-1" x-text="person.name"></span>
                              </a>
                            </div>
                          </template>
                        </div>
                      </div>
                    </template>
                  </div>
                  <div class="d-flex flex-column pl-2">
                    <button :class="\`btn btn-sm mb-1 btn-primary \${selected == 'about' ? 'border-dark' : ''}\`" type="button" @click="selected = 'about'">
                      <span class="btn-text">About</span>
                    </button>
                    <button :class="\`btn btn-sm mb-1 btn-primary \${selected == 'when' ? 'border-dark' : ''}\`" type="button" @click="selected = 'when'">
                      <span class="btn-text">When</span>
                    </button>
                    <button :class="\`btn btn-sm mb-1 btn-primary \${selected == 'prizes' ? 'border-dark' : ''}\`" type="button" @click="selected = 'prizes'">
                      <span class="btn-text">Prizes</span>
                    </button>
                    <button :class="\`btn btn-sm mb-1 btn-primary \${selected == 'sponsors' ? 'border-dark' : ''}\`" type="button" @click="selected = 'sponsors'">
                      <span class="btn-text">Sponsors</span>
                    </button>
                    <button :class="\`btn btn-sm mb-1 btn-primary \${selected == 'team' ? 'border-dark' : ''}\`" type="button" @click="selected = 'team'">
                      <span class="btn-text">Team</span>
                    </button>
                  </div>
                </div>
              </div>`
              this.createPane({
                name: "info",
                title: "Information",
                recreate: `createInfoPane`,
                taskbar_title: "Information",
                initial_body_elem: elem,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/help_book_big-1.png",
                width: "600px",
                height: "300px",
                transform: "center",
                ...params,
              });
            }

            createRegisterPane(params) {
              const elem = `
              {% include "components/errors.html" %}
              {% with form = Forms.auth.RegistrationForm() %}

                {% from "macros/forms.html" import render_extra_fields %}
                <form class="d-flex flex-column h-100 w-100 user-select-none" method="post" accept-charset="utf-8" autocomplete="off" role="form" @submit.prevent="desktop.doRegisterForm($event)">
                  <div class="flex-grow-1 overflow-hidden">
                    <div class="d-flex flex-row h-100">
                      <img src="/themes/uiuctf-2023-ctfd-theme/static/img/register-sidebar.jpg">
                      <div class="d-flex flex-column flex-grow-1 px-3 py-2">
                        <p>Enter the basic information for the new user.</p>
                        <div class="row my-1">
                          <div class="col-3">
                            <span>{{ form.name.label(class="form-label") }}</span>
                          </div>
                          <div class="col d-flex flex-column">
                            <div class="w95-input-border">
                              {{ form.name(class="form-control", value=name) }}
                            </div>
                            <small class="font-xsmall text-muted">
                              Your username on the site
                            </small>
                          </div>
                        </div>
                        <div class="row my-1">
                          <div class="col-3">
                            <span>{{ form.email.label(class="form-label") }}</span>
                          </div>
                          <div class="col d-flex flex-column">
                            <div class="w95-input-border">
                              {{ form.email(class="form-control", value=email) }}
                            </div>
                            <small class="font-xsmall text-muted">
                              Never shown to the public
                            </small>
                          </div>
                        </div>
                        <div class="row my-1">
                          <div class="col-3">
                            <span>{{ form.password.label(class="form-label") }}</span>
                          </div>
                          <div class="col d-flex flex-column">
                            <div class="w95-input-border">
                              {{ form.password(class="form-control", value=password) }}
                            </div>
                            <small class="font-xsmall text-muted">
                              Password used to log into your account
                            </small>
                          </div>
                        </div>
                        {{ render_extra_fields(form.extra) }}
                        {% if Configs.tos_or_privacy %}
                          <p>
                            By registering, you agree to the
                            <a href="{{ Configs.privacy_link }}" rel="noopener" target="_blank">privacy policy</a>
                            and <a href="{{ Configs.tos_link }}" rel="noopener" target="_blank">terms of service</a>
                          </p>
                        {% endif %}
                        <p class="pt-4">To continue, click Next.</p>
                      </div>
                    </div>
                  </div>
                  <hr class="py-0 my-0">
                  <div class="d-flex flex-row justify-content-end py-2 px-2">
                    <button class="btn btn-sm btn-primary" disabled>
                      <span class="btn-text">< Back</span>
                    </button>
                    <button class="btn btn-sm btn-primary" name="_submit" value="Submit">
                      <span class="btn-text">Next ></span>
                    </button>
                  </div>
                  {{ form.nonce() }}
                </form>
              {% endwith %}
              `;

              this.createPane({
                name: "register",
                title: "Register for UIUCTF 2023",
                taskbar_title: "Register",
                recreate: `createRegisterPane`,
                initial_body_elem: elem,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/msagent-1.png",
                hide_minimize: true,
                hide_maximize: true,
                disable_resize: true,
                disable_padding: true,
                width: "600px",
                height: "450px",
                transform: "center",
                ...params,
              });
            }
            async createScoreboardPane(params) {
              const elem = `
              {% include "components/errors.html" %}
              <div class="score-graph d-flex align-items-center" x-data="ScoreboardDetail" x-ref="scoregraph">
                <div class="d-flex flex-column text-center">
                  <i class="fas fa-circle-notch fa-spin fa-3x fa-fw spinner"></i>
                </div>
              </div>

              <div class="d-flex flex-row justify-content-between mt-1"><div>Top 10</div><a href="/scoreboard" class="btn btn-primary">View Full Scoreboard</a></div>
              {% cache 60, CacheKeys.PUBLIC_SCOREBOARD_TABLE %}
                {% if scoreboard_standings %}
                  <!-- id="scoreboard" -->
                  <div class="d-flex flex-row"> 
                    <div class="d-flex flex-column flex-grow-1">
                      <div class="w95-input-border">
                        <table class="table table-striped">
                          <thead>
                            <tr>
                              <td style="width: 10px"><b>Place</b></td>
                              <td><b>{{ get_mode_as_word(capitalize=True) }}</b></td>
                              <td><b>Score</b></td>
                            </tr>
                          </thead>

                          <tbody>
                          {% for standing in scoreboard_standings %}
                            <tr>
                              <th scope="row" class="text-center">{{ loop.index }}</th>
                              <td>
                                <a href="#" @click="desktop.createPublicTeamPane({ PANE_TEAM_ID: {{ standing.account_id }}}); event.stopPropagation();">
                                  {{ standing.name | truncate(50) }}

                                  {% if standing.oauth_id %}
                                    {% if Configs.user_mode == 'teams' %}
                                      <a href="https://majorleaguecyber.org/t/{{ standing.name }}">
                                        <span class="badge bg-primary ms-2">Official</span>
                                      </a>
                                    {% elif Configs.user_mode == 'users' %}
                                      <a href="https://majorleaguecyber.org/u/{{ standing.name }}">
                                        <span class="badge bg-primary ms-2">Official</span>
                                      </a>
                                    {% endif %}
                                  {% endif %}
                                </a>
                              </td>
                              <td>{{ standing.score }}</td>
                            </tr>
                          {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                {% else %}
                  <div> no scoreboard_standings </div>
                {% endif %}
              {% endcache %}
              `
              this.createPane({
                name: "scoreboard",
                title: "Scoreboard",
                recreate: `createScoreboardPane`,
                taskbar_title: "Scoreboard",
                initial_body_elem: elem,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/chart1-1.png",
                width: "400px",
                height: "600px",
                ...params,
              });
            }

            async createSettingsPane(params) {
              const elem = `<div class="row">
{% from "macros/forms.html" import render_extra_fields %}
<div class="col-md-3 offset-md-1 mb-3 mb-md-0">
  <div class="nav flex-column nav-pills" role="tablist">
    <button
        class="nav-link active" id="settings-profile-tab" data-bs-toggle="pill"
        data-bs-target="#profile" role="tab"
    >Profile
    </button>
    <button
        class="nav-link" id="settings-tokens-tab" data-bs-toggle="pill" data-bs-target="#tokens"
        role="tab"
    >Access Tokens
    </button>
  </div>
</div>

<div class="col-md-8">
  <div class="tab-content" id="v-pills-tabContent">
    <div class="tab-pane fade show active" id="profile" role="tabpanel">
      {% include "components/errors.html" %}

      {% with form = Forms.self.SettingsForm(country=settings_country) %}
        <form
            method="post" accept-charset="utf-8" autocomplete="off" role="form"
            x-data="SettingsForm"
            @submit.prevent="updateProfile()"
            class="form-horizontal"
        >

          <div class="mb-3">
            <b>{{ form.name.label(class="form-label") }}</b>
            {{ form.name(class="form-control", value=settings_name) }}
          </div>

          <div class="mb-3">
            <b>{{ form.email.label(class="form-label") }}</b>
            {{ form.email(class="form-control", value=settings_email) }}
          </div>

          <hr>

          <div class="mb-3">
            <b>{{ form.confirm.label(class="form-label") }}</b>
            {{ form.confirm(class="form-control") }}
          </div>
          <div class="mb-3">
            <b>{{ form.password.label(class="form-label") }}</b>
            {{ form.password(class="form-control") }}
          </div>

          <hr>

          <div class="mb-3">
            <b>{{ form.affiliation.label(class="form-label") }}</b>
            {{ form.affiliation(class="form-control", value=settings_affiliation or "") }}
          </div>
          <div class="mb-3">
            <b>{{ form.website.label(class="form-label") }}</b>
            {{ form.website(class="form-control", value=settings_website or "") }}
          </div>
          <div class="mb-3">
            <b>{{ form.country.label(class="form-label") }}</b>
            {{ form.country(class="form-control form-select", value=settings_country) }}
          </div>

          <hr>

          {{ render_extra_fields(form.extra) }}

          <div id="results" class="mb-3">
            <div
                class="alert alert-success alert-dismissible submit-row" role="alert"
                x-cloak="success" x-show="success"
            >
              <strong>Success!</strong>
              Your profile has been updated
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
                <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close.png" alt="">
                <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close_pressed.png" alt="">
              </button>
            </div>


            <template x-for="(msg, idx) in errors" :key="idx">
              <div class="alert alert-danger alert-dismissible" role="alert">
                <span class="sr-only">Error:</span>
                <span x-text="msg"></span>
                <button
                    type="button" class="btn-close" data-bs-dismiss="alert"
                    aria-label="Close"
                >
                <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close.png" alt="">
                <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close_pressed.png" alt="">
                </button>
              </div>
            </template>
          </div>

          <div class="mb-3">
            {{ form.submit(class="btn btn-primary float-end px-4") }}
          </div>
        </form>
      {% endwith %}
    </div>

    <div class="tab-pane fade" id="tokens" role="tabpanel">

      {% with form = Forms.self.TokensForm() %}
        <form method="POST" x-data="TokensForm" @submit.prevent="generateToken()" class="mb-3">
          <div class="modal" tabindex="-1" x-ref="tokenModal">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">API Key Generated</h5>
                  <button
                      type="button" class="btn-close" data-bs-dismiss="modal"
                      aria-label="Close"
                  ><img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close.png" alt="">
                <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close_pressed.png" alt=""></button>
                </div>

                <div class="modal-body">
                  <p>Please copy your API Key, it won't be shown again!</p>

                  <div class="input-group mb-3">
                    <input
                        type="text" class="form-control bg-white" x-ref="token"
                        x-model="token" readonly
                    >
                    <button
                        class="btn btn-outline-secondary px-3" type="button"
                        @click="copyToken()"
                    >
                      <i class="fas fa-clipboard"></i>
                    </button>
                  </div>
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <span class="btn-text">Got it!</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <b>{{ form.expiration.label(class="form-label") }}</b>
            {{ form.expiration(class="form-control") }}
          </div>

          <div class="row">
            <div class="col">
              {{ form.submit(class="btn btn-block btn-primary float-end px-4") }}
            </div>
          </div>
        </form>
      {% endwith %}

      {% if settings_tokens %}
        <hr>

        <h4 class="text-center mt-3">Active Tokens</h4>

        {# This has to be wrapping the table modal, because div with modal will get pushed out
           of the table and alpine ref will not work #}
        <div x-data="Tokens">
          <div
              class="modal fade" x-ref="confirmModal" tabindex="-1" role="dialog"
              aria-modal="true"
          >
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Delete Token</h5>
                  <button
                      type="button" class="btn-close" data-bs-dismiss="modal"
                      aria-label="Close"
                  ><img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close.png" alt="">
                <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close_pressed.png" alt="">
                  </button>
                </div>

                <div class="modal-body">
                  <p>Are you sure you want to delete this token?</p>
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                    <span class="btn-text">No</span>
                  </button>
                  <button
                      type="button" class="btn btn-primary" data-bs-dismiss="modal"
                      @click="deleteSelectedToken()"
                  >
                    <span class="btn-text">Yes</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <table class="table table-striped">
            <thead>
            <tr>
              <td class="text-center"><b>Created</b></td>
              <td><b>Expiration</b></td>
              <td><b>Delete</b></td>
            </tr>
            </thead>
            <tbody>
            {% for token in settings_tokens %}
              <tr x-ref="token-{{ token.id }}">
                <td class="text-center">
                  <span x-text="'{{ token.created.strftime('%Y-%m-%d %H:%M') }}'" data-time="{{ token.created | isoformat }}"></span>
                </td>
                <td>
                  <span x-text="'{{ token.created.strftime('%Y-%m-%d %H:%M') }}'" data-time="{{ token.expiration | isoformat }}"></span>
                </td>
                <td class="text-center">
                  <span
                      class="delete-token" role="button"
                      @click="deleteTokenModal({{ token.id }})">
                      Delete
                  </span>
                </td>
              </tr>
            {% endfor %}

            </tbody>
          </table>
        </div>
      {% endif %}

    </div>
  </div>
</div>
</div>`
              this.createPane({
                name: "settings",
                title: "Settings",
                taskbar_title: "Settings",
                recreate: 'createSettingsPane',
                initial_body_elem: elem,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/settings_gear-1.png",
                hide_close: false,
                width: "400px",
                height: "400px",
                transform: "translate(100px, 100px)",
                ...params
              });
              
            }

            async createConfirmClosePane(params) {
              this.createPane({
                name: "close",
                title: "Confirm Close All",
                taskbar_title: "Confirm Close All",
                initial_body_elem: `
                  <div class="d-flex flex-row user-select-none">
                    <div class="m-2">
                      <img class="flex-shrink-0" src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/recycle_bin_full-0.png">
                    </div>
                    <div class="m-2">
                      <p>
                        Are you sure you want to close all panes?
                      </p>
                    </div>
                  </div>
                  <div class="d-flex flex-row justify-content-center">
                    <button class="btn btn-sm btn-primary" @click="desktop.closeAllPanes()">
                      <span class="btn-text">OK</span>
                    </button>
                  </div>
                `,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/recycle_bin_full-1.png",
                hide_minimize: true,
                hide_maximize: true,
                disable_resize: true,
                hide_close: false,
                transform: "center",
                ...params
              });
            }
            async createChallengesPane(params) {
              // <div
              //   x-data="ChallengeBoard"
              //   @load-challenges.window="loadChallenges()"
              //   @load-challenge.window="loadChallenge($event.detail)"
              //   class="bg-white w-100 h-100 d-flex flex-column"
              // >
              const elem = `
                <div x-data="ChallengeBoard" class="d-flex flex-column h-100 w-100" @load-challenges.window="loadChallenges()">
                  <div
                    class="d-flex flex-grow-1 mx-2 mb-2 overflow-hidden w95-input-border"
                  >
                    <div class="d-flex flex-column flex-grow-1 px-3 py-2 bg-white overflow-auto">
                      <div x-show="!loaded">
                        <div class="min-vh-50 d-flex align-items-center">
                          <div class="text-center w-100">
                            <i class="fas fa-circle-notch fa-spin fa-3x fa-fw spinner"></i>
                            <span class="sr-only">Loading...</span>
                          </div>
                        </div>
                      </div>

                      <div x-show="loaded">
                        <template x-for="(category, idx) in (getCategories() || [])" :key="idx">
                          <div class="mb-2">
                            <div class="category-header">
                              <p x-text="category" class="h5 m-0"></p>
                            </div>
                            <hr class="mt-0" />
                            <div style="display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(64px, 128px));">
                              <template x-for="(c, idx) in getChallenges(category)" :key="c.id">
                                <div
                                  class="d-flex flex-column text-center mx-auto"
                                  style="width: 64px;"
                                  @click="desktop.createChallengePane({ id: c.id, icon_path: c.icon_path }); event.stopPropagation();"
                                >
                                  <img
                                    :value="c.id"
                                    x-show="!c.solved_by_me"
                                    :src="c.icon_path"
                                  >
                                  <img
                                    :value="c.id"
                                    x-show="c.solved_by_me"
                                    src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/check-0.png"
                                  >
                                  <div>
                                    <p x-text="c.name"></p>
                                    <span x-text="c.value"></span>
                                  </div>
                                </div>
                              </template>
                            </div>

                          </div>
                        </template>
                      </div>
                    </div>
                  </div>
                </div>
              `
              
              // Display error if /challenges is not accessible
                const response = await window.CTFd.fetch("/api/v1/challenges")
                await response.json().then(data => {
                
                this.createPane({
                  name: "challenges",
                  title: "Challenges",
                  recreate: 'createChallengesPane',
                  taskbar_title: "Challenges",
                  initial_body_elem: elem,
                  icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/directory_open_file_mydocs_small-1.png",
                  width: "600px",
                  height: "400px",
                  disable_padding: true,
                  ...params
                });
                if (!data.success) {
                    this.createAlertPane({
                      title: "403 Error",
                      content: `/challenges is not accessible.<br/><br/>Access is denied.<br/><br/>You may need to <a href="#" @click="desktop.createLoginPane(); event.stopPropagation();">log in</a>, or <a href="#" @click="desktop.createPrivateTeamPane(); event.stopPropagation();">be on a team</a>.`,
                    });
                }

              }).catch(err => {
                this.createAlertPane({
                    title: "302 Error",
                    content: `/challenges is not accessible.<br/><br/>Access is denied.<br/><br/>You may need to <a href="#" @click="desktop.createLoginPane(); event.stopPropagation();">log in</a>, or <a href="#" @click="desktop.createPrivateTeamPane(); event.stopPropagation();">be on a team</a>.`,
                })     
              })
            }

            // Form ONLY for initial reset, not for the email callback. email callback goes back to main reset password page.
            async createResetPasswordPane(params) {
              const elem = `
                {% include "components/errors.html" %}
                {% with form = Forms.auth.ResetPasswordRequestForm() %}
                  <form method="post" accept-charset="utf-8" autocomplete="off" role="form" @submit.prevent="desktop.doResetPasswordForm($event)">
                    <div class="d-flex flex-column flex-grow-1">
                      <p>Please provide the email address associated with your account below.</p>
                      <div class="mb-3">
                        {{ form.email.label(class="form-label") }}
                        <div class="w95-input-border">
                          {{ form.email(class="form-control ") }}
                        </div>
                      </div>
                      <div class="d-flex flex-row flex-grow-1 justify-content-end">
                        <button class="btn btn-sm btn-primary" id="_submit" name="_submit" type="submit" value="Submit">
                          <span class="btn-text">Submit</span>
                        </button>
                      </div>
                    </div>
                    {{ form.nonce() }}
                  </form>
                {% endwith %}
              `
              this.createPane({
                name: "reset_password",
                title: "Reset Password",
                taskbar_title: "Reset Password",
                recreate: 'createResetPasswordPane',
                initial_body_elem: elem,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/users_key-0.png",
                hide_maximize: true,
                disable_resize: true,
                ...params
              });
            }

            // invite.html is not themed
            
            // public.html
            async createPublicTeamPane({ PANE_TEAM_ID, ...params }) {
              // Will need an API call or GET/POSTs to the real page (b/c teamID)
              const elem = `
  <div x-data="TeamGraphsPublic(${PANE_TEAM_ID})">
    <div class="container">
      <h1 id="team-id" x-text="team?.data?.name"></h1>

        <h3 class="mx-1" x-show.important="team?.data?.affiliation">
          <span class="badge bg-primary rounded-pill" x-text="team?.data?.affiliation"></span>
        </h3>

        <h3 class="mx-1" x-show.important="team?.data?.country">
					<span class="badge bg-primary rounded-pill">
						<i :class="\`flag-\${team?.data?.country ? team.data.country.toLowerCase() : ''}\`"></i>
						<span x-text="team?.data?.country">
					</span>
        </h3>

      <div class="pt-2" x-show.important="team?.data?.website && team?.data?.website.startsWith('http')">
        <a x-bind:href="team?.data?.website" target="_blank" style="color: inherit;" rel="noopener">
          <i
              class="fas fa-external-link-alt fa-2x px-2" data-toggle="tooltip" data-placement="top"
              x-bind:title="team?.data?.website"
          ></i>
        </a>
      </div>

      <hr class="w-50 mx-auto" x-show="!!team?.data?.website">

      <div class="d-flex flex-row">

        <h4 id="team-place" class="d-flex flex-row align-items-baseline">
          <div x-text="team?.data?.place"></div>
          <small x-show="team?.data?.place" class="pl-1">place</small>
        </h2>

        <h4 id="team-score" class="pl-2 d-flex flex-row align-items-baseline">
          <div x-text="team?.data?.score"></div>
          <small x-show="team?.data?.score" class="pl-1">points</small>
        </h2>
      </div>
    </div>

    {% include "components/errors.html" %}

    <br>

    <div class="row">
      <div class="col-md-12">
        <h3>Members</h3>
        <table class="table table-striped">
          <thead>
          <tr>
            <td><b>User Name</b></td>
            <td><b>Score</b></td>
          </tr>
          </thead>
          <tbody>
          <template x-for="member in (members.data || [])">
            <tr>
              <td>
                <a @click="desktop.createPublicUserPane({ PANE_USER_ID: member.id }); event.stopPropagation();" href="#" x-text="member.name"></a>
              </td>
              <td x-text="member.points"></td>
            </tr>
          </template>
          </tbody>
        </table>
      </div>
    </div>

        <div class="row" x-show="awards?.data && awards.data.length > 0">
          <div class="col-md-12">
            <h3>Awards</h3>
          </div>

          <template x-for="award in (awards.data || [])">
            <div class="col-md-3 col-sm-6">
              <p class="text-center">
                <i :class="\`award-icon award-\${ award.icon } fa-2x\`"></i> <br>
                <strong x-text="award.name"></strong>
              </p>

              <p class="text-center" x-text="award.category"></p>

              <p class="text-center" x-text="award.description"></p>

              <p class="text-center" x-text="award.value"></p>
            </div>
          </template>
        </div>

        <br>

      <div class="row">
        <div class="col-md-12">
          <h3>Solves</h3>
          <table class="table table-striped">
            <thead>
            <tr>
              <td class="text-center"><b>Challenge</b></td>
              <td class="d-none d-md-block d-lg-block"><b>Category</b></td>
              <td><b>Value</b></td>
              <td><b>Time</b></td>
            </tr>
            </thead>
            <tbody>
            <template x-for="solve in (solves?.data || [])">
              <tr>
                <td class="text-center">
                  <a href="#" x-text="solve.challenge.name" @click="desktop.createChallengePane({ id: solve.challenge.id }); event.stopPropagation();">
                  </a>
                </td>
                <td class="d-none d-md-block d-lg-block" x-text="solve.challenge.category"></td>
                <td x-text="solve.challenge.value"></td>
                <td class="solve-time">
                  <span x-text="new Date(solve.date).toLocaleString()"></span>
                </td>
              </tr>
            </template>
            </tbody>
          </table>
        </div>
      </div>

      <div class="clearfix"></div>

      <div class="row">
        <div class="col-md-7 d-block d-lg-block py-4">
          <div class="progress">
            <div 
              class="progress-bar" 
              role="progressbar" 
              :style="{ width: \`\${getSolvePercentage()}%\`, 'background-color': 'rgb(0, 209, 64)' }" 
            >
            </div>
            <div 
              class="progress-bar" 
              role="progressbar" 
              :style="{ width: \`\${getFailPercentage()}%\`, 'background-color': 'rgb(207, 38, 0)' }"
            >
            </div>
          </div>
          <div class="ps-2 float-start">
            <svg height="16" width="16">
              <circle cx="8" cy="8" r="5" fill="rgb(0, 209, 64)" />
            </svg>
            <small x-text="\`Solves (\${getSolvePercentage()}%)\`"></small>
          </div>
          <div class="ps-2 float-start">
            <svg height="16" width="16">
              <circle cx="8" cy="8" r="5" fill="rgb(207, 38, 0)" />
            </svg>
            <small x-text="\`Fails (\${getFailPercentage()}%)\`"></small>
          </div>
        </div>
        <div class="col-md-7 d-block d-lg-block py-4">
          <div class="progress">
            <template x-for="category in (getCategoryBreakdown() || [])" :key="category.name">
              <div 
                class="progress-bar" 
                role="progressbar" 
                :style="{ width: \`\${category.percent}%\`, 'background-color': category.color }"
              >
              </div>
            </template>
          </div>
          <template x-for="category in (getCategoryBreakdown() || [])" :key="category.name">
            <div class="ps-2 float-start">
              <svg height="16" width="16">
                <circle cx="8" cy="8" r="5" :fill="category.color" />
              </svg>
              <small x-text="\`\${category.name} (\${category.percent}%)\`"></small>
            </div>
          </template>
        </div>

        <br class="clearfix">

        <div class="col-md-12 d-block">
          <div x-ref="scoregraph" class="score-graph w-100 d-flex align-items-center">
            <div class="text-center w-100">
              <i class="fas fa-circle-notch fa-spin fa-3x fa-fw spinner"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="row min-vh-25" x-show="solves?.data && solves.data.length === 0">
        <h3 class="opacity-50 text-center w-100 justify-content-center align-self-center">
          No solves yet
        </h3>
      </div>
    </div>
  </div>
`
              this.createPane({
                name: "team",
                title: `Team Info`,
                taskbar_title: `Team Info`,
                recreate: `createPublicTeamPane`,
                PANE_TEAM_ID,
                initial_body_elem: elem,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/address_book_users.png",
                hide_maximize: true,
                disable_resize: false,
                transform: "center",
                width: "400px",
                height: "500px",
                ...params
              });
            }

            async createPublicUserPane({PANE_USER_ID, ...params}) {
              const elem = `
              <div x-data="UserGraphsPublic(${PANE_USER_ID})">

  <div class="container">
    <h1 x-text="user.data.name"></h1>

      <h2 x-show="user.data.team_id">
        <a href="#" @click="desktop.createPublicTeamPane({ PANE_TEAM_ID: user.data.team_id }); event.stopPropagation();">
          <span class="badge bg-secondary" x-text="team.data.name">
          </span>
        </a>
      </h2>

    <div class="pt-2" x-show="user.data.affiliation || user.data.country">
        <h3 class="d-inline-block mx-1" x-show.important="user.data.affiliation">
          <span class="badge rounded-pill bg-primary" x-text="user.data.affiliation"></span>
        </h3>

        <h3 class="d-inline-block mx-1" x-show.important="user.data.country">
          <span class="badge rounded-pill bg-primary">
              <i class="\`flag-\${user.data.country.toLowerCase()}\`"></i>
              <span x-text="user.data.country"></span>
          </span>
        </h3>
    </div>

    <div class="d-flex flex-row pb-3" x-show="user.data.place || user.data.data">
      <h4 class="d-flex flex-row align-items-baseline" x-show="user.data.place">
        <span x-text="user.data.place" class="pr-1"></span>
          <small>place</small>
        </h4>
        <h4 class="d-flex flex-row align-items-baseline ml-2" x-show="user.data && user.data.score">
        <span x-text="user.data.score" class="pr-1"></span>
        <small>points</small>
      </h4>
    </div>

    <div class="pt-3" x-show="user.data.website">
        <a x-bind:href="user.data.website" target="_blank" style="color: inherit;" rel="noopener">
          <i
              class="fas fa-external-link-alt fa-2x px-2" data-toggle="tooltip" data-placement="top"
              x-bind:title="user.data.website"
          ></i>
        </a>
    </div>
  {% include "components/errors.html" %}
    <div class="row">
      <div class="col-md-12">
        <h3>Solves</h3>
        <table class="table table-striped">
          <thead>
          <tr>
            <td><b>Challenge</b></td>
            <td class="d-none d-md-block d-lg-block"><b>Category</b></td>
            <td><b>Value</b></td>
            <td><b>Time</b></td>
          </tr>
          </thead>
          <tbody>
            <template x-for="solve in solves.data">
              <tr>
                <td class="text-center">
                  <a href="#" x-text="solve.challenge.name" @click="desktop.createChallengePane({ id: solve.challenge.id }); event.stopPropagation();">
                  </a>
                </td>
                <td class="d-none d-md-block d-lg-block" x-text="solve.challenge.category"></td>
                <td x-text="solve.challenge.value"></td>
                <td class="solve-time">
                  <span x-text="new Date(solve.date).toLocaleString()"></span>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>

    <div class="clearfix"></div>

    <div class="row">
      <div class="col-md-6 d-none d-md-block d-lg-block py-4">
        <div class="progress">
          <div 
            class="progress-bar" 
            role="progressbar" 
            :style="{ width: \`\${getSolvePercentage()}%\`, 'background-color': 'rgb(0, 209, 64)' }" 
          >
          </div>
          <div 
            class="progress-bar" 
            role="progressbar" 
            :style="{ width: \`\${getFailPercentage()}%\`, 'background-color': 'rgb(207, 38, 0)' }"
          >
          </div>
        </div>
        <div class="ps-2 float-start">
          <svg height="16" width="16">
            <circle cx="8" cy="8" r="5" fill="rgb(0, 209, 64)" />
          </svg>
          <small x-text="\`Solves (\${getSolvePercentage()}%)\`"></small>
        </div>
        <div class="ps-2 float-start">
          <svg height="16" width="16">
            <circle cx="8" cy="8" r="5" fill="rgb(207, 38, 0)" />
          </svg>
          <small x-text="\`Fails (\${getFailPercentage()}%)\`"></small>
        </div>
      </div>
      <div class="col-md-6 d-none d-md-block d-lg-block py-4">
        <div class="progress">
          <template x-for="category in getCategoryBreakdown()" :key="category.name">
            <div 
              class="progress-bar" 
              role="progressbar" 
              :style="{ width: \`\${category.percent}%\`, 'background-color': category.color }"
            >
            </div>
          </template>
        </div>
        <template x-for="category in getCategoryBreakdown()" :key="category.name">
          <div class="ps-2 float-start">
            <svg height="16" width="16">
              <circle cx="8" cy="8" r="5" :fill="category.color" />
            </svg>
            <small x-text="\`\${category.name} (\${category.percent}%)\`"></small>
          </div>
        </template>
      </div>

      <br class="clearfix">

      <div class="col-md-12 d-none d-md-block d-lg-block py-4">
        <div id="score-graph" x-ref="scoregraph" class="w-100 d-flex align-items-center">
          <div class="text-center w-100">
            <i class="fas fa-circle-notch fa-spin fa-3x fa-fw spinner"></i>
          </div>
        </div>
      </div>
    </div>
  <div class="row min-vh-25" x-show="solves.length === 0">
    <h3 class="opacity-50 text-center w-100 justify-content-center align-self-center">
      No solves yet
    </h3>
  </div>
</div>
</div>
`
              this.createPane({
                name: "user",
                title: `User Info`,
                taskbar_title: `User Info`,
                recreate: `createPublicUserPane`,
                PANE_USER_ID,
                initial_body_elem: elem,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/address_book_user.png",
                hide_maximize: true,
                disable_resize: false,
                transform: "center",
                width: "400px",
                height: "500px",
                ...params
              });
            }

            // teams.html
            async createTeamListingPane() {
              // Will need an API call or GET/POSTs to the real page (b/c paginated response)
            }

            // join_team.html
            async doTeamJoinForm(event) {
              const response = await fetch('/teams/join', {
                method: 'POST',
                redirect: "manual",
                body: new FormData(event.target)
              })
              const statusCode = response.status
              const html = await response.text()
              
              const matches = html.match(/role="alert"[\s\S]*?span>([\s\S]*?)<\/span>/m)
              const error = (matches && matches.length > 1) ? matches[1] : null
              if (error === null) {
                this.closePanes('team_join')
                this.closePanes('team_create')
                this.closePanes('team')
                if (statusCode === 403) {
                  this.createAlertPane({"title": "Team Join Error","content": "Team Join form expired. Please try again."});
                } else {
                  this.createAlertPane({"title": "Team Join Success", "type": "success", "content": "You successfully joined the team."})
                }
                location.reload();
              } else {
                this.createAlertPane({"title" : 'Team Join Error', "content": error });
              }
            }

            async createPrivateTeamJoinPane(params) {
              const elem = `
              <div>

              {% include "components/errors.html" %}

              {% with form = Forms.teams.TeamJoinForm() %}
                <form method="POST" @submit.prevent="desktop.doTeamJoinForm($event)">
                  <div class="mb-3">
                    {{ form.name.label(class="form-label") }}
                    {{ form.name(class="form-control") }}
                  </div>

                  <div class="mb-3">
                    {{ form.password.label(class="form-label") }}
                    {{ form.password(class="form-control") }}
                  </div>

                  <div class="row pt-3">
                    <div class="col-md-12">
                      {{ form.submit(class="btn btn-success float-end px-4") }}
                    </div>
                  </div>
                  {{ form.nonce() }}
                </form>
              {% endwith %}
              </div>
              `
              this.createPane({
                name: "team_join",
                title: `Team Join`,
                taskbar_title: `Team Join`,
                recreate: `createPrivateTeamJoinPane`,
                initial_body_elem: elem,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/address_book_users.png",
                hide_maximize: true,
                disable_resize: false,
                transform: "center",
                width: "600px",
                height: "400px",
                ...params
              });
              // /teams/join
            }

            async doTeamCreateForm(event) {
              const response = await fetch('/teams/new', {
                method: 'POST',
                redirect: "manual",
                body: new FormData(event.target)
              })
              const statusCode = response.status
              const html = await response.text()
              
              const matches = html.match(/role="alert"[\s\S]*?span>([\s\S]*?)<\/span>/m)
              const error = (matches && matches.length > 1) ? matches[1] : null
              if (error === null || error.trim().length === 0) {
                this.closePanes('team_create')
                this.closePanes('team')
                this.closePanes('team_join')
                if (statusCode === 403) {
                  this.createAlertPane({"title": "Team Create Error","content": "Team Create form expired. Please try again."});
                } else {
                  this.createAlertPane({"title": "Team Create Success", "type": "success", "content": "You successfully created the team."})
                }
                location.reload();
              } else {
                this.createAlertPane({"title" : 'Team Create Error', "content": error });
                this.closePanes('team')
              }
            }
            // new_team.html
            async createPrivateTeamCreatePane(params) {
              const elem = `
              <div>
                {% include "components/errors.html" %}

                {% with form = Forms.teams.TeamRegisterForm() %}
                  {% from "macros/forms.html" import render_extra_fields %}
                  <form method="POST" @submit.prevent="desktop.doTeamCreateForm($event)">
                    <div class="mb-3">
                      <b>{{ form.name.label(class="form-label") }}</b>
                      {{ form.name(class="form-control") }}
                    </div>
                    <div class="mb-3">
                      <b>{{ form.password.label(class="form-label") }}</b>
                      {{ form.password(class="form-control") }}
                    </div>

                    {{ render_extra_fields(form.extra) }}

                    <div class="row ">
                      <div class="col-md-12">
                        <p>After creating your team, share the team name and password with your teammates so they can join your
                          team.</p>
                        {{ form.submit(class="btn btn-success float-end px-4") }}
                      </div>
                    </div>
                    {{ form.nonce() }}
                  </form>
                {% endwith %}
              </div>
              `

              this.createPane({
                name: "team_create",
                title: `Team Create`,
                taskbar_title: `Team Create`,
                recreate: `createPrivateTeamCreatePane`,
                initial_body_elem: elem,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/address_book_users.png",
                hide_maximize: true,
                disable_resize: false,
                transform: "center",
                width: "600px",
                height: "400px",
                ...params
              });
              // /teams/new
            }

            // private.html + teams_enrollment.html
            async createPrivateTeamPane(params) {
              // This pane should either show your team, or buttons to the join/create team panes
              const elem = `
                  {% if privateteam_enrollment_needed %}
                      <p>
                        Looks like you are not on a team yet. Please join or create a team.  
                      </p>

                <div class="d-flex flex-row justify-content-center">
                  <div class="mt-3 pr-3">
                    <a class="btn btn-primary" href="#" @click="desktop.createPrivateTeamJoinPane(); event.stopPropagation();">Join Team</a>
                  </div>
                  <div class="mt-3 pl-3">
                    <a class="btn btn-primary" href="#" @click="desktop.createPrivateTeamCreatePane(); event.stopPropagation();">Create Team</a>
                  </div>
              </div>
                {% elif team != None %}
                <div class="d-flex flex-row h-100" x-data="{ selected: 'info' }">
    <!-- Panels -->
    <div class="info-panel d-flex flex-column p-3 w-100 h-100">
  <template x-if="selected == 'info'">
    <div>
      <div class="d-flex flex-row justify-content-center">
        <h3 id="team-id" team-id="{{ team.id if team else None }}">{{ team.name if team else None }}</h3>
      </div>
      {% if team and team.oauth_id %}
        <a href="https://majorleaguecyber.org/t/{{ team.name }}">
          <h3><span class="badge bg-primary">Official</span></h3>
        </a>
      {% endif %}

      {% if team and team.affiliation %}
        <h3 class="d-inline-block">
          <span class="badge bg-primary">{{ team.affiliation }}</span>
        </h3>
      {% endif %}

      {% if team and team.country %}
        <h3 class="d-inline-block">
          <span class="badge bg-primary">
            <i class="flag-{{ team.country.lower() }}"></i>
            {{ lookup_country_code(team.country) }}
          </span>
        </h3>
      {% endif %}

      <div class="d-flex flex-row">

      <h4 id="team-place">
        {# This intentionally hides the team's place when scores are hidden because this can be their internal profile
           and we don't want to leak their place in the CTF. #}
        {# Public page hiding is done at the route level #}
        {% if scores_visible() %}
          {% if privateteam_place %}
            <span>{{ privateteam_place }}</span>
            <small>place</small>
          {% endif %}
        {% endif %}
      </h4>

      <h4 id="team-score">
        {% if privateteam_score %}
          <span class="ml-3">{{ privateteam_score }}</span>
          <small>points</small>
        {% endif %}
      </h4>
      </div>
      <div x-data="CaptainMenu">
        <button class="edit-team" @click="editTeam()">
          Edit Team
        </button>
        <button class="edit-captain" @click="chooseCaptain()">
          Choose Captain
        </button>

        <button class="invite-members" @click="inviteMembers()">
          Invite Users
        </button>
        <button class="disband-team" @click="disbandTeam()">
          Disband Team
        </button>
      </div>

      <div class="pt-3">{% if team and team.website and (team.website.startswith('http://') or team.website.startswith('https://')) %}
          <a href="{{ team.website }}" target="_blank" style="color: inherit;" rel="noopener">
            <i
                class="fas fa-external-link-alt fa-2x px-2 pt-2"
                data-toggle="tooltip" data-placement="top"
                title="{{ team.website }}"
            ></i>
          </a>
        {% endif %}
        </div>
      </div>
  </template>

  <template x-if="selected == 'members'">
    <div>
    {% include "components/errors.html" %}
    <div class="row min-vh-25">
      <div class="col-md-12">
        <h3>Members</h3>
        <table class="table table-striped">
          <thead>
          <tr>
            <td><b>User Name</b></td>
            <td><b>Score</b></td>
          </tr>
          </thead>
          <tbody>
          {% for member in ((team or {}).members or []) %}
            <tr>
              <td>
                <a href="#" @click="desktop.createPublicUserPane({ PANE_USER_ID: {{ member.id }}}); event.stopPropagation();">
                  {{ member.name }}
                </a>
                {% if team and team.captain_id == member.id %}
                  <span class="badge bg-primary ms-2">Captain</span>
                {% endif %}
              </td>
              <td>{{ member.score }}</td>
            </tr>
          {% endfor %}

          </tbody>
        </table>
      </div>
    </div>
  </div>
  </template>    

  <!-- Panel 3 -->
  <template x-if="selected == 'solves'">
    <div>

    {% if privateteam_solves %}
    <div class="row">
      <div class="col-md-12">
        <h3>Solves</h3>
        <table class="table table-striped">
          <thead>
          <tr>
            <td><b>Challenge</b></td>
            <td class="d-none d-md-block d-lg-block"><b>Category</b></td>
            <td><b>Value</b></td>
            <td><b>Time</b></td>
          </tr>
          </thead>
          <tbody>

          {% for solve in privateteam_solves %}
            <tr>
              <td>
                <a href="#" @click="desktop.createChallengePane({ id: {{ solve.challenge.id }}}); event.stopPropagation();">
                  {{ solve.challenge.name }}
                </a>
              </td>
              <td class="d-none d-md-block d-lg-block">{{ solve.challenge.category }}</td>
              <td>{{ solve.challenge.value }}</td>
              <td class="solve-time">
                <span data-time="{{ solve.date | isoformat }}">{{ solve.date }}</span>
              </td>
            </tr>
          {% endfor %}

          </tbody>
        </table>
      </div>
    </div>

    <div class="row" x-data="TeamGraphs">
      <div class="col-md-7 d-none d-md-block d-lg-block py-4">
        <div class="progress">
          <div 
            class="progress-bar" 
            role="progressbar" 
            :style="{ width: \`\${getSolvePercentage()}%\`, 'background-color': 'rgb(0, 209, 64)' }" 
          >
          </div>
          <div 
            class="progress-bar" 
            role="progressbar" 
            :style="{ width: \`\${getFailPercentage()}%\`, 'background-color': 'rgb(207, 38, 0)' }"
          >
          </div>
        </div>
        <div class="ps-2 float-start">
          <svg height="16" width="16">
            <circle cx="8" cy="8" r="5" fill="rgb(0, 209, 64)" />
          </svg>
          <small x-text="\`Solves (\${getSolvePercentage()}%)\`"></small>
        </div>
        <div class="ps-2 float-start">
          <svg height="16" width="16">
            <circle cx="8" cy="8" r="5" fill="rgb(207, 38, 0)" />
          </svg>
          <small x-text="\`Fails (\${getFailPercentage()}%)\`"></small>
        </div>
      </div>
      <div class="col-md-7 d-none d-md-block d-lg-block py-4">
        <div class="progress">
          <template x-for="category in getCategoryBreakdown()" :key="category.name">
            <div 
              class="progress-bar" 
              role="progressbar" 
              :style="{ width: \`\${category.percent}%\`, 'background-color': category.color }"
            >
            </div>
          </template>
        </div>
        <template x-for="category in getCategoryBreakdown()" :key="category.name">
          <div class="ps-2 float-start">
            <svg height="16" width="16">
              <circle cx="8" cy="8" r="5" :fill="category.color" />
            </svg>
            <small x-text="\`\${category.name} (\${category.percent}%)\`"></small>
          </div>
        </template>
      </div>
    </div>
    {% else %}
      <div class="row min-vh-25">
        <h3 class="opacity-50 text-center w-100 justify-content-center align-self-center">
          No solves yet
        </h3>
      </div>
    {% endif %}
    </div>
  </template>
    </div>
    <div class="d-flex flex-column pl-2">
      <button :class="\`btn btn-sm mb-1 btn-primary \${selected == 'info' ? 'border-dark' : ''}\`" type="button" @click="selected = 'info'"><span
          class="btn-text">Info</span></button>
      <button :class="\`btn btn-sm mb-1 btn-primary \${selected == 'members' ? 'border-dark' : ''}\`" type="button" @click="selected = 'members'"><span
          class="btn-text">Members</span></button>
      <button :class="\`btn btn-sm mb-1 btn-primary \${selected == 'solves' ? 'border-dark' : ''}\`" type="button" @click="selected = 'solves'"><span
          class="btn-text">Solves</span></button>
    </div>
  </div>
                {% endif %}
              `
              // TODO: add this
              this.createPane({
                name: "team",
                title: `My Team`,
                taskbar_title: `My Team`,
                recreate: `createPrivateTeamPane`,
                initial_body_elem: elem,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/address_book_users.png",
                hide_maximize: true,
                disable_resize: false,
                transform: "center",
                width: "600px",
                height: "400px",
                ...params
              });
            }

            async createPrivateUserPane(params) {
              const elem = `
              <div>
      <div class="d-flex flex-column">

        <h1>{{ user.name }}</h1>
        
        {% if user.team_id %}
        <h2>
          <a href="#" @click="desktop.createPrivateTeamPane({{ user.team_id }}); event.stopPropagation()">
            <span class="badge bg-secondary">
              {{ user.team.name }}
						</span>
          </a>
        </h2>
        {% endif %}
      </div>
        
        <div class="pt-2">
          {% if user.oauth_id %}
          <a href="https://majorleaguecyber.org/u/{{ user.name }}">
            <h3 class="d-inline-block mx-1"><span class="badge rounded-pill bg-primary">Official</span></h3>
          </a>
        {% endif %}

        {% if user.affiliation %}
          <h3 class="d-inline-block mx-1">
            <span class="badge rounded-pill bg-primary">{{ user.affiliation }}</span>
          </h3>
        {% endif %}

        {% if user.country %}
          <h3 class="d-inline-block mx-1">
            <span class="badge rounded-pill bg-primary">
                <i class="flag-{{ user.country.lower() }}"></i>
                {{ lookup_country_code(user.country) }}
            </span>
          </h3>
        {% endif %}
      </div>

      <div class="pt-2">
        {% for field in user.fields %}
          <h3 class="d-block">
            {{ field.name }}: {{ field.value }}
          </h3>
        {% endfor %}
      </div>

      {% if user.fields %}
        <hr class="w-50 mx-auto">
      {% endif %}

      <div class="d-flex flex-row">
        <h2>
          {% if privateuser_account and privateuser_account.place %}
            {{ privateuser_account.place }} <small>place</small>
          {% endif %}
        </h2>
        <h2 class="pl-3">
          {% if privateuser_account and privateuser_account.place %}
            {{ privateuser_account.score }} <small>points</small>
          {% endif %}
        </h2>
      </div>

      <div class="pt-3">
        {% if user.website %}
          <a href="{{ user.website }}" target="_blank" style="color: inherit;" rel="noopener">
            <i
                class="fas fa-external-link-alt fa-2x px-2" data-toggle="tooltip" data-placement="top"
                title="{{ user.website }}"
            ></i>
          </a>
        {% endif %}
      </div>
    {% include "components/errors.html" %}

    {% set solves = user.solves %}
    {% set awards = user.awards or [] %}

    {% if solves or awards %}
      {% if awards %}
        <div class="row">
          <div class="col-md-12">
            <h3>Awards</h3>

          </div>
          {% for award in awards %}
            <div class="col-md-3 col-sm-6">
              <p class="text-center">
                <i class="award-icon award-{{ award.icon }} fa-2x"></i>
                <br>
                <strong>{{ award.name }}</strong>
              </p>
              <p class="text-center">{{ award.category or "" }}</p>
              <p class="text-center">{{ award.description or "" }}</p>
              <p class="text-center">{{ award.value }}</p>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <br>

      <div class="row">
        <div class="col-md-12">
          <h3>Solves</h3>
          <table class="table table-striped">
            <thead>
            <tr>
              <td><b>Challenge</b></td>
              <td class="d-none d-md-block d-lg-block"><b>Category</b></td>
              <td><b>Value</b></td>
              <td><b>Time</b></td>
            </tr>
            </thead>
            <tbody>
            {% for solve in solves %}
              <tr>
                <td>
                  <a href="#" @click="desktop.createChallengePane({ id: {{ solve.challenge.id }}}); event.stopPropagation();">
                    {{ solve.challenge.name }}
                  </a>
                </td>
                <td class="d-none d-md-block d-lg-block">{{ solve.challenge.category }}</td>
                <td>{{ solve.challenge.value }}</td>
                <td class="solve-time">
                  <span data-time="{{ solve.date | isoformat }}"></span>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="clearfix"></div>

      <div class="row" x-data="UserGraphs">
        <div class="col-md-6 d-none d-md-block d-lg-block py-4">
          <div class="progress">
            <div 
              class="progress-bar" 
              role="progressbar" 
              :style="{ width: \`\${getSolvePercentage()}%\`, 'background-color': 'rgb(0, 209, 64)' }" 
            >
            </div>
            <div 
              class="progress-bar" 
              role="progressbar" 
              :style="{ width: \`\${getFailPercentage()}%\`, 'background-color': 'rgb(207, 38, 0)' }"
            >
            </div>
          </div>
          <div class="ps-2 float-start">
            <svg height="16" width="16">
              <circle cx="8" cy="8" r="5" fill="rgb(0, 209, 64)" />
            </svg>
            <small x-text="\`Solves (\${getSolvePercentage()}%)\`"></small>
          </div>
          <div class="ps-2 float-start">
            <svg height="16" width="16">
              <circle cx="8" cy="8" r="5" fill="rgb(207, 38, 0)" />
            </svg>
            <small x-text="\`Fails (\${getFailPercentage()}%)\`"></small>
          </div>
        </div>
        <div class="col-md-6 d-none d-md-block d-lg-block py-4">
          <div class="progress">
            <template x-for="category in getCategoryBreakdown()" :key="category.name">
              <div 
                class="progress-bar" 
                role="progressbar" 
                :style="{ width: \`\${category.percent}%\`, 'background-color': category.color }"
              >
              </div>
            </template>
          </div>
          <template x-for="category in getCategoryBreakdown()" :key="category.name">
            <div class="ps-2 float-start">
              <svg height="16" width="16">
                <circle cx="8" cy="8" r="5" :fill="category.color" />
              </svg>
              <small x-text="\`\${category.name} (\${category.percent}%)\`"></small>
            </div>
          </template>
        </div>
        <br class="clearfix">
        <div class="col-md-12 d-none d-md-block d-lg-block py-4">
          <div id="score-graph" x-ref="scoregraph" class="w-100 d-flex align-items-center">
            <div class="text-center w-100">
              <i class="fas fa-circle-notch fa-spin fa-3x fa-fw spinner"></i>
            </div>
          </div>
        </div>
      </div>
    {% else %}
      <div class="row min-vh-25">
        <h3 class="opacity-50 text-center w-100 justify-content-center align-self-center">
          No solves yet
        </h3>
      </div>
    {% endif %}
  </div>
`
              this.createPane({
                name: "user",
                title: `My Profile`,
                taskbar_title: `My Profile`,
                recreate: `createPrivateUserPane`,
                initial_body_elem: elem,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/address_book_user.png",
                hide_maximize: true,
                disable_resize: false,
                transform: "center",
                width: "400px",
                height: "500px",
                ...params
              });
            }
            async createChallengePane({ id, ...params }) {
              const c = await window.CTFd.pages.challenges.getChallenge(id)
              if (!c) {
                this.createAlertPane({
                  title: "Access Error",
                  content: `Challenge is not accessible.<br/><br/>Access is denied.`,
                });
                return;
              }
              // Generate unique ID for tab selection
              let uniq, elem_id;
              do {
                uniq = Math.random().toString(16).slice(2);
                elem_id = `challenge_${id}_${uniq}`;
              } while (document.querySelector(`#${elem_id}`));
              const elem = `
<div class="d-flex flex-column h-100 w-100" id="${elem_id}" x-data="Challenge" x-init="id = ${c.id}">
  <ul class="nav nav-tabs user-select-none" id="${elem_id}_tablist" role="tablist">
    <li class="nav-item">
      <a
        class="nav-link active"
        id="${elem_id}_tab_challenge"
        data-bs-target="#${elem_id}_tabcontent_challenge"
        @click="showChallenge()"
      >
        Challenge
      </a>
    </li>
    <li class="nav-item">
      <a
        class="nav-link"
        id="${elem_id}_tab_solves"
        data-bs-target="#${elem_id}_tabcontent_solves"
        @click="showSolves()"
        x-init="loadSolves()"
        x-text="solves.length + ' Solve' + (solves.length != 1 ? 's' : '')"
      >
        ${c.solves} Solve${c.solves != 1 ? "s" : ""}
      </a>
    </li>
  </ul>
  <div class="tab-content flex-grow-1" id="${elem_id}_tabcontent">
    <div class="tab-pane show active" role="tabpanel"
      id="${elem_id}_tabcontent_challenge"
      aria-labelledby="${elem_id}_tabcontent_challenge"
    >
      <span id="${elem_id}_name">${c.name}</span>
      <p id="${elem_id}_value" class="mb-0">${c.value} points</p>
      <p id="${elem_id}_tags">${c.tags.join(", ")}</p>
      <p id="${elem_id}_description">${marked.parse(c.description)}</p>
      ${(() => {
        if (c.connection_info) {
          if (c.connection_info.startsWith("http")) {
            return `<p><a target="_blank" rel="noopener" href="${c.connection_info}">${c.connection_info}</a></p>`;
          } else {
            return `<p>${c.connection_info}</p>`;
          }
        }
        return "";
      })()}
      <!-- Hints -->
      ${(() => {
        let hint_html = "";
        if (c.hints.length > 0) {
          // Sort hints by cost
          const hints = c.hints.sort((a, b) => a.cost - b.cost);
          hint_html += `<div class="w95-section-border"><p class="w95-section-legend">Hints</p>`;
          hints.forEach((h, idx) => {
            if (h.content) {
              hint_html += `<p class="m-0">Hint ${idx}:</p>${marked.parse(h.content)}`;
            } else {
              hint_html += `
                <p class="m-0">Hint ${idx}:</p>
                <div class="d-flex flex-row justify-content-between align-items-center">
                  <p class="m-0">Unlock for ${h.cost} points</p>
                  <button class="btn btn-sm btn-primary" @click="unlockHint(${h.id})">
                    <span class="btn-text">Unlock</span>
                  </button>
                </div>
              `;
            }
          })
          hint_html += `</div>`;
        }
        return hint_html;
      })()}
      <!-- Files -->
      ${(() => {
        let files_html = "";
        if (c.files.length > 0) {
          files_html += `<div class="w95-section-border"><p class="w95-section-legend">Files</p>`;
          c.files.forEach(filepath => {
            const filename = filepath.split("/").pop().split("?")[0];
            files_html += `
            <div class="d-flex flex-row justify-content-between align-items-center mb-1">
              <p class="m-0">${filename}</p>
              <a href="${filepath}" target="_blank" rel="noopener">
                <button class="btn btn-sm btn-primary">
                  <span class="btn-text">Download</span>
                </button>
              </a>
            </div>
            `;
          })
          files_html += `</div>`;
        }
        return files_html;
      })()}
    </div>
    <div class="tab-pane" role="tabpanel"
      id="${elem_id}_tabcontent_solves"
      aria-labelledby="${elem_id}_tabcontent_solves"
    >
      <div class="w95-input-border">
        <table class="table table-striped">
          <thead>
            <tr>
              <td>
                <span><b>Name</b></span>
              </td>
              <td>
                <span><b>Date</b></span>
              </td>
            </tr>
          </thead>
          <tbody id="challenge-solves-names">
            <template x-for="solve in solves">
              <tr>
                <td>
                  <p class="mb-0"><a @click="desktop.createPublicTeamPane({ PANE_TEAM_ID: solve.account_id }); event.stopPropagation();" href="#" x-text="solve.name"></a></p>
                </td>
                <td>
                  <p class="mb-0" x-text="solve.date"></p>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>
  </div>
      <div class="d-flex flex-column mt-3">
        <input
          id="${elem_id}_challenge-id"
          type="hidden"
          class="challenge-id"
          value="${c.id}"
        />
        <div class="w95-input-border">
          <input
            id="${elem_id}_challenge-input"
            type="text"
            class="challenge-input form-control"
            x-model="submission"
            @keyup.enter="submitChallenge()"
            placeholder="${c.solved_by_me ? "Challenge solved!" : "uiuctf{...}"}"
            ${c.solved_by_me ? "disabled" : ""}
          />
        </div>
        <div class="d-flex flex-row justify-content-between mt-1">
          <div @render-status-popup.window="desktop.createAlertPane({'title': 'Challenge Submit', 'type': response.data.status === 'correct'? 'success': 'error', 'content': response.data.message})">
          </div>
          <button
            id="${elem_id}_challenge-submit"
            class="btn btn-sm btn-primary"
            type="submit"
            @click.debounce.500ms="submitChallenge()"
            ${c.solved_by_me ? "disabled" : ""}
          >
            <span class="btn-text">Submit</span>
          </button>
        </div>
      </div>
</div>
              `
              this.createPane({
                name: "challenge",
                title: `${c.name}`,
                taskbar_title: `${c.name}`,
                recreate: `createChallengePane`,
                id,
                initial_body_elem: elem,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/computer-3.png",
                hide_maximize: true,
                disable_resize: true,
                transform: "center",
                width: "400px",
                height: "500px",
                ...params
              });
            }

            async triggerLogout() {
              await fetch('/logout')
              this.closeAllPanes()
              this.createAlertPane({"title": "Logout Success", "type": "success", "content": "You have been logged out."})
              location.reload()
            }

            async doLoginForm(event) {
              const response = await fetch('/login', {
                method: 'POST',
                body: new FormData(event.target)
              })
              const statusCode = response.status
              const html = await response.text()
    
              const matches = html.match(/role="alert"[\s\S]*?span>([\s\S]*?)<\/span>/m)
              const error = (matches && matches.length > 1) ? matches[1] : null
              if (error === null || error.includes('not started')) {
                this.closePanes('login')
                if (statusCode === 403) {
                  this.createAlertPane({"title": "Login Error", "content": "Login form expired. Please try again."});
                } else {
                  this.createAlertPane({"title": "Login Success", "type": "success", "content": "Welcome back to UIUCTF 2023."})
                }
                location.reload();
              } else if (!!error) {
                this.createAlertPane({"title": 'Login Error', "content": error});
              }
            }

            async doResetPasswordForm(event) {
              const response = await fetch('/reset_password', {
                method: 'POST',
                body: new FormData(event.target)
              })
              const statusCode = response.status
              const html = await response.text()
              
              const matches = html.match(/role="alert"[\s\S]*?span>([\s\S]*?)<\/span>/m)
              const error = (matches && matches.length > 1) ? matches[1] : null
              if (error === null || error.includes('not started')) {
                this.closePanes('reset_password')
                if (statusCode === 403) {
                  this.createAlertPane({"title": "Reset Password Error","content": "Reset Password form expired. Please try again."});
                } else {
                  this.createAlertPane({"title": "Reset Password Success", "type": "success", "content": "An email should be sent. If not, contact the organizers."})
                }
                location.reload();
              } else if (!!error) {
                this.createAlertPane({"title" : 'Reset Password Error', "content": error });
              }
            }
            async doRegisterForm(event) {
              const response = await fetch('/register', {
                method: 'POST',
                body: new FormData(event.target)
              })
              const statusCode = response.status
              const html = await response.text()
              
              const matches = html.match(/role="alert"[\s\S]*?span>([\s\S]*?)<\/span>/m)
              const error = (matches && matches.length > 1) ? matches[1] : null
              if (error === null || error.includes('not started')) {
                this.closePanes('register')
                if (statusCode === 403) {
                  this.createAlertPane({"title": "Registration Error","content": "Register form expired. Please try again."});
                } else {
                  this.createAlertPane({"title": "Registration Success", "type": "success", "content": "Welcome to UIUCTF 2023!"})
                }
                location.reload();
              } else if (!!error) {
                this.createAlertPane({"title" : 'Registration Error', "content": error });
              }
            }
          }

          // Create Desktop
          desktop = new Desktop({
            id: "index3",
            elem: this.$refs.desktop,
            taskbar: this.$refs.taskbar
          });

          Alpine.store('globals').user = window.init.userName
        },

      }))
    })
  </script>
{% endblock head %}

</head>
<body>
<!-- End base -->

{% block page %}
  <div x-data="desktop" class="min-vh-100 d-flex flex-column bg-secondary">
    <!-- Desktop -->
    <div class="d-flex flex-grow-1 position-relative" x-ref="desktop"></div>

    <!-- Officially don't care - private user modals -->
    {% if team %}
    <div id="team-edit-modal" class="modal fade">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-action text-center w-100">Edit Team</h2>
            <button type="button" class="cursor-pointer btn-close" data-bs-dismiss="modal" aria-label="Close">
              <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close.png" alt="">
                <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close_pressed.png" alt="">
            </button>
          </div>
  
          <div class="modal-body clearfix" x-data="TeamEditModal">
            {% with form = Forms.teams.TeamSettingsForm(obj=team) %}
              {% from "macros/forms.html" import render_extra_fields %}
              <form id="team-info-form" method="POST" @submit.prevent="updateProfile()">
  
                <div class="mb-2">
                  <b>{{ form.name.label(clas="mb-2") }}</b>
                  {{ form.name(class="form-control") }}
                  <small class="form-text text-muted">
                    {{ form.name.description }}
                  </small>
                </div>
  
                <div class="mb-2">
                  <b>{{ form.password.label(clas="mb-2") }}</b>
                  {{ form.password(class="form-control") }}
                  <small class="form-text text-muted">
                    {{ form.password.description }}
                  </small>
                </div>
  
                <div class="mb-2">
                  <b>{{ form.confirm.label(clas="mb-2") }}</b>
                  {{ form.confirm(class="form-control") }}
                  <small class="form-text text-muted">
                    {{ form.confirm.description }}
                  </small>
                </div>
  
                <div class="mb-2">
                  <b>{{ form.website.label(clas="mb-2") }}</b>
                  {{ form.website(class="form-control") }}
                  <small class="form-text text-muted">
                    {{ form.website.description }}
                  </small>
                </div>
  
                <div class="mb-2">
                  <b>{{ form.affiliation.label(clas="mb-2") }}</b>
                  {{ form.affiliation(class="form-control") }}
                  <small class="form-text text-muted">
                    {{ form.affiliation.description }}
                  </small>
                </div>
  
                <div class="mb-2">
                  <b>{{ form.country.label(clas="mb-2") }}</b>
                  {{ form.country(class="form-control form-select") }}
                  <small class="form-text text-muted">
                    {{ form.country.description }}
                  </small>
                </div>
  
                <hr>
  
                {{ render_extra_fields(form.extra) }}
  
                <div id="results">
                  <div
                      class="alert alert-success alert-dismissible submit-row"
                      role="alert" x-cloak="success" x-show="success"
                  >
                    <strong>Success!</strong>
                    Your team's profile has been updated
                    <button type="button" class="cursor-pointer btn-close" data-bs-dismiss="alert" aria-label="Close">
                      <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close.png" alt="">
                <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close_pressed.png" alt="">
                    </button>
                  </div>
  
                  <template x-for="(msg, idx) in errors" :key="idx">
                    <div class="alert alert-danger alert-dismissible" role="alert">
                      <span class="sr-only">Error:</span>
                      <span x-text="msg"></span>
  
                      <button type="button" class="cursor-pointer btn-close" data-bs-dismiss="alert" aria-label="Close">
                        <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close.png" alt="">
                <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close_pressed.png" alt="">
                      </button>
                    </div>
                  </template>
                </div>
  
                {{ form.submit(class="btn btn-primary float-end px-4 modal-action") }}
              </form>
            {% endwith %}
          </div>
        </div>
      </div>
    </div>
  
    <div id="team-captain-modal" x-data="TeamCaptainModal" class="modal fade">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-action text-center w-100">Choose Captain</h2>
            <button type="button" class="cursor-pointer btn-close" data-bs-dismiss="modal" aria-label="Close">
              <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close.png" alt="">
                <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close_pressed.png" alt="">
            </button>
          </div>
          <div class="modal-body clearfix">
            {% with form = Forms.teams.TeamCaptainForm(captain_id=team.captain_id) %}
              <form id="team-captain-form" method="POST" @submit.prevent="updateCaptain()">
                <div class="mb-3">
                  {{ form.captain_id.label(class="form-label") }}
                  {% for member in team.members %}
                    {# Append members to the select choices #}
                    {% set _ = form.captain_id.choices.append((member.id, member.name)) %}
                  {% endfor %}
                  {{ form.captain_id(class="form-control form-select mb-2") }}
                </div>
                <div id="results">
                  <div
                      class="alert alert-success alert-dismissible submit-row"
                      role="alert"
                      x-cloak="success"
                      x-show="success"
                  >
                    <strong>Success!</strong>
                    Your captain rights have been transferred
                    <button type="button" class="cursor-pointer btn-close" data-bs-dismiss="alert" aria-label="Close">
                      <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close.png" alt="">
                <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close_pressed.png" alt="">
                    </button>
                  </div>
                  <template x-for="(msg, idx) in errors" :key="idx">
                    <div class="alert alert-danger alert-dismissible" role="alert">
                      <span class="sr-only">Error:</span>
                      <span x-text="msg"></span>
                      <button type="button" class="cursor-pointer btn-close" data-bs-dismiss="alert" aria-label="Close">
                        <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close.png" alt="">
                <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close_pressed.png" alt="">
                      </button>
                    </div>
                  </template>
                </div>
                {{ form.submit(class="btn btn-primary float-end px-4 modal-action") }}
              </form>
            {% endwith %}
          </div>
        </div>
      </div>
    </div>
  
    <div id="team-invite-modal" x-data="TeamInviteModal" class="modal fade">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-action text-center w-100">Invite Users</h2>
            <button type="button" class="cursor-pointer btn-close" data-bs-dismiss="modal" aria-label="Close">
              <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close.png" alt="">
                <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close_pressed.png" alt="">
            </button>
          </div>
          <div class="modal-body clearfix">
            {% with form = Forms.teams.TeamInviteForm() %}
              <form method="POST">
                <div class="mb-3">
                  <b>{{ form.link.label(class="form-label") }}</b>
  
                  <div class="input-group mb-3">
                    {{ form.link(id="team-invite-link", class="form-control", **{"x-ref": "link", "x-bind:value": "$store.inviteToken"}) }}
  
                    <button class="btn btn-outline-secondary px-3" type="button" @click="copy()">
                      <i class="fas fa-clipboard"></i>
                    </button>
                  </div>
  
                  <small class="form-text text-muted">
                    Share this link with your team members for them to join your team
                  </small>
                  <small class="form-text text-muted">
                    Invite links can be re-used and expire after 1 day
                  </small>
                </div>
              </form>
            {% endwith %}
          </div>
        </div>
      </div>
    </div>
  
    <div id="team-disband-modal" x-data="TeamDisbandModal" class="modal fade">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-action text-center w-100">Disband Team</h2>
            <button type="button" class="cursor-pointer btn-close" data-bs-dismiss="modal" aria-label="Close">
              <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close.png" alt="">
                <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close_pressed.png" alt="">
            </button>
          </div>
          <div class="modal-body">
            <p class="mb-0">Are you sure you want to disband your team?</p>
  
            <div class="mt-3">
              <template x-for="(msg, idx) in errors" :key="idx">
                <div class="alert alert-danger" role="alert">
                  <span class="sr-only">Error:</span>
                  <span x-text="msg"></span>
                </div>
              </template>
            </div>
  
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">No</button>
            <button type="button" class="btn btn-primary" @click="disbandTeam()" :disabled="errors.length > 0">Yes</button>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  
    <!-- Taskbar -->
    <footer class="d-flex position-relative">
      <nav class="navbar navbar-main navbar-expand-lg navbar-dark justify-content-between navbar-footer user-select-none taskbar">
        <ul x-ref="taskbar" class="navbar-nav d-flex flex-row">
          <li class="nav-item start-button" @click.away="$store.globals.show_start = false">
            <div class="start-menu-container">
              <div class="start-menu" x-show="$store.globals.show_start" style="display: none;">
                <div class="logo-bar">
                  <img src="/themes/uiuctf-2023-ctfd-theme/static/img/start-menu-logo-sideways.png" />
                </div>
                <div class="main-options">
                  <div :class="''" @click="desktop.createChallengesPane()">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/directory_open_file_mydocs_small-1.png" />
                    <span class="user-select-none">
                      Challenges
                    </span>
                  </div>
                  <div :class="''" @click="desktop.createScoreboardPane()">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/chart1-1.png" />
                    <span>
                      Scoreboard
                    </span>
                  </div>
                  <div x-bind:disabled="$store.globals.user === null" :class="$store.globals.user === null ? 'pe-none item-disabled user-select-none' : ''" @click="desktop.createPrivateUserPane()">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/address_book_user.png" />
                    <span>
                      My Profile
                    </span>
                  </div>
                  <div x-bind:disabled="$store.globals.user === null" :class="$store.globals.user === null ? 'pe-none item-disabled user-select-none' : ''" @click="desktop.createPrivateTeamPane()">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/address_book_users.png" />
                    <span>
                      My Team
                    </span>
                  </div>
                  <div style="border-bottom: 1px solid #808080"  @click="desktop.createInfoPane()">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/help_book_big-1.png" />
                    <span>
                      Information
                    </span>
                  </div>
                  <div x-show="$store.globals.user !== null"  style="border-top: 1px solid #ffffff" @click="desktop.createSettingsPane()"">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/settings_gear-1.png" />
                    <span>
                      Settings
                    </span>
                  </div>
                  <div x-show="$store.globals.user !== null" @click="desktop.triggerLogout()">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/key_win-1.png" />
                    <span x-text="'Log out...'">
                    </span>
                  </div>
                  <div x-show="$store.globals.user === null" @click="desktop.createRegisterPane()" style="border-top: 1px solid #ffffff">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/msagent-1.png" />
                    <span>Register</span>
                  </div>
                  <div x-show="$store.globals.user === null" @click="desktop.createLoginPane()">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/key_win-1.png" />
                    <span x-text="'Log in...'">
                    </span>
                  </div>
                </div>
              </div>
            </div>
            <a class="nav-link d-flex flex-row font-weight-bold" role="button" :class="{ 'pane-focused': $store.globals.show_start === true }" @click="desktop.markAllUnfocused(); $store.globals.show_start = !$store.globals.show_start">
              <img class="taskbar-icon" src="/themes/uiuctf-2023-ctfd-theme/static/img/uiuctf-2023-pwny.svg" />
              <div>Start</div>
            </a>
          </li>
        </ul>
        <div class="d-flex flex-row align-items-center">
          <div class="mr-1 cursor-pointer font-xsmall d-flex flex-row align-items-center" @click="desktop.createConfirmClosePane();">
            <div>Close All</div>
            <img class="pl-1" src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/recycle_bin_full-1.png" />
          </div>
          <div id="time" class="time text-center">12:00 AM</div>
        </div>
      </nav>
    </footer>
  </div>
{% endblock %}

{% block scripts %}
  {{ Assets.js("assets/js/index.js") }}
  {{ Assets.js("assets/js/desktop.js") }}
  <script type="text/javascript">
    function refreshTime() {
      const time = new Date().toLocaleTimeString([], {hour: "numeric", minute:'2-digit'});
      document.getElementById("time").innerText = time;
    }
    if (document.getElementById("time")) {
      refreshTime();
      setInterval(refreshTime, 5000)
    }
  </script>
{% endblock %}

{% include "components/notifications.html" %}

{{ Plugins.scripts }}

{{ Configs.theme_footer }}
</body>
</html>
