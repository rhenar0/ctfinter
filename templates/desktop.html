{% extends "base.html" %}

{% block head %}
  <link rel="stylesheet prefetch" href="/themes/uiuctf-2023-ctfd-theme/static/windows-95-ui-kit/css/bootstrap.min.css">
  <link rel="stylesheet prefetch" href="/themes/uiuctf-2023-ctfd-theme/static/windows-95-ui-kit/css/w95.css">
  <script src="/themes/uiuctf-2023-ctfd-theme/static/custom/moveable.min.js"></script>
  <script src="/themes/uiuctf-2023-ctfd-theme/static/custom/marked.min.js"></script>
  <script>
    marked.use({
      langPrefix: '',
      mangle: false,
      headerIds: false
    });
  </script>
  <style>
    /* Moveable.js overrides */
    .item-disabled {
      cursor: not-allowed !important;
      color: #6c757d;
    }
    .moveable-line {
      height: 15px !important;
      opacity: 0 !important;
    }
    .moveable-control {
      opacity: 0 !important;
    }

    body {
      overflow: hidden;
    }

     /* Disable image dragging */
    img {
      -webkit-user-drag: none;
      -khtml-user-drag: none;
      -moz-user-drag: none;
      -o-user-drag: none;
      user-drag: none;
      image-rendering: pixelated;
    }

    .taskbar {
      z-index: 2000;
    }

    .taskbar-button {
      margin-right: 3px;
      width: 160px;
      min-width: 32px;
    }

    .start-button {
      margin-right: 4px !important;
    }

    .start-menu-container {
      position: absolute;
      height: 238px;
      width: 164px;
      /* background-color: red; */
    }

    .start-menu {
      position: relative;
      top: -100%;
      height: 100%;
      width: 100%;
      display: flex;
      flex-flow: row;
      background-color: #c0c0c0;
      border-top: 2px solid #ffffff;
      border-left: 2px solid #ffffff;
      border-bottom: 2px solid #000000;
      border-right: 2px solid #000000;
    }

    .start-menu .logo-bar {
      background-color: #808080;
      width: 21px;
      margin-top: 1px;
      margin-left: 1px;
      margin-right: 0px;
      margin-bottom: 1px;
      padding-bottom: 7px;
      display: flex;
      justify-content: center;
      align-items: end;
      image-rendering: pixelated;
    }

    .start-menu .main-options {
      display: flex;
      flex-flow: column;
      flex-grow: 1;
      justify-content: center;
    }

    .start-menu .main-options > div {
      display: flex;
      flex-flow: row;
      flex-grow: 1;
      align-items: center;
      padding-left: 10px;
      padding-right: 7px;
    }

    .start-menu .main-options > div:hover {
      background-color: #000080;
      color: #ffffff;
    }

    .start-menu .main-options img {
      height: 26px;
      margin-right: 10px;
    }

    .pane {
      overflow-x: hidden;
      overflow-y: hidden;
      position: absolute;
      top: 0;
      left: 0;
      min-width: 128px;
      min-height: 64px;
    }

    .card-header-content {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      user-select: none;
    }

    .card-body {
      max-height: 100%;
      overflow-y: auto;
    }

    .pane-control-icon {
      image-rendering: pixelated;
      user-select: none;
    }
    .pane-control-icon > img {
      pointer-events: none;
      display: none;
      height: 0.875rem;
    }
    .pane-control-icon > img:first-child {
      display: block;
    }
    .pane-control-icon:active > img:first-child {
      display: none;
    }
    .pane-control-icon:active > img:last-child {
      display: block;
    }
    .close-icon {
      margin-left: 0.125rem;
    }

    /* For help pane */
    .info-panel {
        background: #feffd1;
        max-height: 300px;
        overflow: auto;
    }
  </style>

  <script type="text/javascript">
    function timer(expiry) {
      return {
        expiry: expiry,
        remaining:null,
        init() {
          this.setRemaining()
          setInterval(() => {
            this.setRemaining();
          }, 1000);
        },
        setRemaining() {
          this.isCountdown = new Date().getTime() > this.expiry;
          const diff = (this.isCountdown) ? this.expiry - new Date().getTime() : new Date().getTime() - this.expiry;
          this.remaining = parseInt(diff / 1000);
        },
        days() {
          return {
            value: this.remaining / 86400,
            remaining:this.remaining % 86400
          };
        },
        hours() {
          return {
            value:this.days().remaining / 3600,
            remaining:this.days().remaining % 3600
          };
        },
        minutes() {
          return {
            value:this.hours().remaining / 60,
            remaining:this.hours().remaining % 60
          };
        },
        seconds() {
          return {
            value: this.minutes().remaining,
          };
        },
        format(value) {
          return ("0" + parseInt(value)).slice(-2)
        },
        time(){
          return {
            days:this.format(this.days().value),
            hours:this.format(this.hours().value),
            minutes:this.format(this.minutes().value),
            seconds:this.format(this.seconds().value),
            text: this.isCountdown ? "left" : ""
          }
        },
      }
    }

    document.addEventListener('alpine:init', () => {
      Alpine.store('globals', {
            user: null,
            show_start: true
      })
      Alpine.data('desktop', () => ({
        init() {
          // TODO: Move classes into a separate JS file
          // TODO: Initial window start (brand new session)
          class Pane {
            constructor(params) {
              // Check required parameters
              if (!params.name) throw new Error("Pane must have a name");
              if (!params.desktop) throw new Error("Pane must be linked to a Desktop");
              if (!params.title) throw new Error("Pane must have a title");
              if (!params.initial_body_elem) throw new Error("Pane must have initial body element");
              this.name = params.name;
              this.desktop = params.desktop;
              this.title = params.title;
              this.taskbar_title = params.taskbar_title ?? params.title;
              this.initial_body_elem = params.initial_body_elem;
              this.icon_path = params.icon_path ?? null;
              this.hide_minimize = params.hide_minimize ?? false;
              this.hide_maximize = params.hide_maximize ?? false;
              this.hide_close = params.hide_close ?? false;
              this.disable_drag = params.disable_drag ?? false;
              this.disable_resize = params.disable_resize ?? false;
              this.#createPaneDOM();

              // Dynamic attributes
              this.transform = params.transform ?? `translate(${params.x ?? 0}px, ${params.y ?? 0}px)`;
              this.z = params.z ?? 0;
              this.width = params.width ?? null;
              this.height = params.height ?? null;
              this.minimized = params.minimized ?? false;
              this.maximized = params.maximized ?? false;
              this.focused = params.focused ?? false;

              this.moveable = new Moveable(document.body, {
                target: this.target,
                dragTarget: this.handle ?? null,
                // Draggable options
                draggable: !this.maximized && !this.disable_drag,
                throttleDrag: 1,
                edgeDraggable: false,
                startDragRotate: 0,
                throttleDragRotate: 0,
                edge: true,
                origin: false,
                // Resizable options
                resizable: !this.maximized && !this.disable_resize,
                throttleResize: 1,
                keepRatio: false,
                renderDirections: ["nw", "ne", "se", "sw"],
              });
              this.#registerListeners();
              this.#commitDOM();
              if (this.transform === "center") {
                this.transform = `translate(${(this.desktop.elem.offsetWidth - this.target.offsetWidth) / 2}px, ${(this.desktop.elem.offsetHeight - this.target.offsetHeight) / 2}px)`;
              }
              this.render();
            }

            #createPaneDOM() {
              // Ensure xref_target is unique
              let uniq, xref_target;
              do {
                uniq = Math.random().toString(16).slice(2);
                xref_target = `${this.name}_${uniq}`;
              } while (document.querySelector(`[x-ref="${xref_target}"]`));
              const xref_target_handle = `${xref_target}_handle`;
              const xref_target_taskbar_button = `${xref_target}_taskbar_button`;

              // Create pane parent
              const pane_elem = document.createElement("div");
              pane_elem.setAttribute("x-ref", xref_target);
              pane_elem.setAttribute("class", "card pane flex-column");

              // Create handle
              const pane_handle = document.createElement("div");
              pane_handle.setAttribute("x-ref", xref_target_handle);
              pane_handle.setAttribute("class", "card-header d-flex flex-row justify-content-between align-items-center");
              const pane_title = document.createElement("div");
              pane_title.setAttribute("class", "card-header-content");
              // TODO: Icon
              pane_title.appendChild(document.createTextNode(this.title));
              pane_handle.appendChild(pane_title);

              // Create pane controls
              const pane_controls = document.createElement("div");
              pane_controls.setAttribute("class", "d-flex flex-row");
              if (!this.hide_minimize) {
                pane_controls.insertAdjacentHTML("beforeend", `
                  <div class="pane-control-icon" x-ref="minimize">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/minimize.png">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/minimize_pressed.png">
                  </div>
                `)
              }
              if (!this.hide_maximize) {
                pane_controls.insertAdjacentHTML("beforeend", `
                  <span x-ref="maximize-restore-group">
                    <div class="pane-control-icon" x-ref="maximize">
                      <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/maximize.png" alt="">
                      <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/maximize_pressed.png" alt="">
                    </div>
                    <div class="pane-control-icon" x-ref="restore">
                      <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/restore.png" alt="">
                      <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/restore_pressed.png" alt="">
                    </div>
                  </span>
                `)
              }
              if (!this.hide_close) {
                pane_controls.insertAdjacentHTML("beforeend", `
                  <div class="pane-control-icon close-icon" x-ref="close">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close.png" alt="">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win95-pane-control/close_pressed.png" alt="">
                  </div>
                `)
              }
              pane_handle.appendChild(pane_controls);
              pane_elem.appendChild(pane_handle);

              // Create pane body
              const pane_body = document.createElement("div");
              pane_body.setAttribute("class", "card-body");
              pane_body.insertAdjacentHTML("beforeend", this.initial_body_elem);
              pane_elem.appendChild(pane_body);

              // Create taskbar button
              const taskbar_button = document.createElement("li");
              taskbar_button.setAttribute("class", "nav-item taskbar-button");
              const taskbar_button_link = document.createElement("a");
              taskbar_button_link.setAttribute("x-ref", xref_target_taskbar_button);
              taskbar_button_link.setAttribute("class", "nav-link d-flex flex-row");
              taskbar_button_link.setAttribute("role", "button");
              const taskbar_button_icon = document.createElement("img");
              taskbar_button_icon.setAttribute("class", "taskbar-icon");
              if (this.icon_path) taskbar_button_icon.setAttribute("src", this.icon_path);
              const taskbar_button_text = document.createElement("div");
              taskbar_button_text.innerText = this.taskbar_title;
              taskbar_button_link.appendChild(taskbar_button_icon);
              taskbar_button_link.appendChild(taskbar_button_text);
              taskbar_button.appendChild(taskbar_button_link);

              // Set created elements
              this.target = pane_elem;
              this.handle = pane_handle;
              this.taskbar_button = taskbar_button_link;
            }

            /**
             * Registers event listeners for all components used to control the pane
             */
            #registerListeners() {
              this.moveable.on("drag", e => {
                e.target.style.transform = e.transform;
                if (this.maximized) this.setMaximized(false);
              });
              this.moveable.on("resize", e => {
                e.target.style.transform = e.transform;
                e.target.style.width = `${e.width}px`;
                e.target.style.height = `${e.height}px`;
              });
              this.moveable.on("dragStart", e => {
                this.desktop.bringToFront(this.target);
              });
              this.moveable.on("resizeStart", e => {
                this.desktop.bringToFront(this.target);
              });
              this.moveable.on("dragEnd", e => {
                if (!this.maximized) {
                  this.transform = e.target.style.transform;
                }
                this.desktop.save();
              });
              this.moveable.on("resizeEnd", e => {
                this.transform = e.target.style.transform;
                this.width = e.target.style.width;
                this.height = e.target.style.height;
                this.desktop.save();
              });
              // If any part of the pane is clicked, bring it to the front
              this.target.addEventListener("click", () => {
                this.desktop.bringToFront(this.target);
              });
              // Maximize/restore on handle double click
              this.handle.addEventListener("dblclick", () => {
                this.setMaximized(!this.maximized);
                this.render();
                this.desktop.save();
              });
              // Minimize buttons
              this.target.querySelectorAll("div[x-ref='minimize']").forEach(
                elem => elem.addEventListener("click", (event) => {
                  this.setMinimized(true);
                  event.stopImmediatePropagation();
                })
              )
              // Maximize buttons
              this.target.querySelectorAll("div[x-ref='maximize']").forEach(
                elem => elem.addEventListener("click", (event) => {
                  this.setMaximized(true);
                  event.stopImmediatePropagation();
                })
              )
              // Restore buttons
              this.target.querySelectorAll("div[x-ref='restore']").forEach(
                elem => elem.addEventListener("click", (event) => {
                  this.setMaximized(false);
                  this.desktop.bringToFront(this.target);
                  event.stopImmediatePropagation();
                })
              )
              // Close buttons
              this.target.querySelectorAll("[x-ref='close']").forEach(
                elem => elem.addEventListener("click", () => {
                  this.close();
                })
              )
              // Swap maximize/restore buttons on maximize-restore-group
              this.target.querySelectorAll("[x-ref='maximize-restore-group']").forEach(
                elem => elem.addEventListener("click", () => {
                  const button_maximize = elem.querySelector("[x-ref='maximize']");
                  const button_restore = elem.querySelector("[x-ref='restore']");
                  if (this.maximized) {
                    button_maximize.style.display = "none";
                    button_restore.style.display = "block";
                  } else {
                    button_maximize.style.display = "block";
                    button_restore.style.display = "none";
                  }
                })
              )
              // Taskbar button
              if (this.taskbar_button) {
                this.taskbar_button.addEventListener("click", () => {
                  this.desktop.bringToFront(this.target);
                  this.setMinimized(false);
                })
              }
            }

            #commitDOM() {
              this.desktop.elem.appendChild(this.target);
              if (this.taskbar_button) this.desktop.taskbar.appendChild(this.taskbar_button);
            }

            #removeDOM() {
              this.desktop.elem.removeChild(this.target);
              if (this.taskbar_button) this.desktop.taskbar.removeChild(this.taskbar_button);
            }

            /**
             * Generate JSON representation of the pane's state for storing
             * @returns {object} JSON object representing the state of the pane
             */
            toJSON() {
              return {
                name: this.name,
                title: this.title,
                taskbar_title: this.taskbar_title,
                initial_body_elem: this.initial_body_elem,
                icon_path: this.icon_path,
                hide_minimize: this.hide_minimize,
                hide_maximize: this.hide_maximize,
                hide_close: this.hide_close,
                disable_drag: this.disable_drag,
                disable_resize: this.disable_resize,
                transform: this.transform,
                z: this.z,
                width: this.width,
                height: this.height,
                minimized: this.minimized,
                maximized: this.maximized,
                focused: this.focused,
              }
            }

            /**
             * Closes the pane by removing its elements from the DOM and desktop state
             */
            close() {
              this.desktop.panes = this.desktop.panes.filter(p => p !== this);
              this.desktop.save();
              this.#removeDOM();
            }

            /**
             * Sets the z-index of the pane and updates the DOM
             * @param {number} value Z-index to set
             */
            setZ(value) {
              this.z = value;
              this.render();
              this.desktop.save();
            }

            /**
             * Sets the minimized state of the pane and updates the DOM
             * @param {boolean} value True if pane should be hidden, false to use previous state
             */
            setMinimized(value) {
              if (this.hide_minimize) return;
              this.minimized = value;
              if (value) this.focused = false;
              this.render();
              this.desktop.save();
            }

            /**
             * Sets the maximized state of the pane and updates the DOM
             * @param {boolean} value True if pane should be maximized, false to use previous state
             */
            setMaximized(value) {
              if (this.hide_maximize) return;
              this.maximized = value;
              this.moveable.draggable = !value && !this.disable_drag;
              this.moveable.resizable = !value && !this.disable_resize;
              this.render();
              this.desktop.save();
            }

            /**
             * Sets whether the pane is focused or not
             * @param {boolean} value True if the pane is focused, false if not
             */
            setFocused(value) {
              this.focused = value;
              this.render();
              this.desktop.save();
            }

            /**
             *  Updates the DOM to reflect the current state of the pane
             */
            render() {
              // Set z-indices of pane and moveable controls
              this.target.style.zIndex = this.z;
              this.moveable.selfElement.style.zIndex = this.z;
              // Swap maximize/restore buttons
              this.target.querySelectorAll("[x-ref='maximize-restore-group']").forEach(
                elem => {
                  const button_maximize = elem.querySelector("[x-ref='maximize']");
                  const button_restore = elem.querySelector("[x-ref='restore']");
                  if (this.maximized) {
                    button_maximize.style.display = "none";
                    button_restore.style.display = "block";
                  } else {
                    button_restore.style.display = "none";
                    button_maximize.style.display = "block";
                  }
                }
              )
              if (this.maximized) {
                this.target.style.transform = `translate(0px, 0px)`;
                this.target.style.width = "100%";
                this.target.style.height = "100%";
              } else {
                this.target.style.transform = this.transform;
                this.target.style.width = this.width;
                this.target.style.height = this.height;
              }
              if (this.minimized) {
                this.target.style.display = "none";
              } else {
                this.target.style.display = "flex";
              }
              // Set color of focused pane handle
              if (this.focused) {
                this.target.classList.add("card-tertiary");
                if (this.taskbar_button) this.taskbar_button.classList.add("pane-focused");
              } else {
                this.target.classList.remove("card-tertiary");
                if (this.taskbar_button) this.taskbar_button.classList.remove("pane-focused");
              }
              this.moveable.updateRect();
            }
          }

          class Desktop {
            constructor(params) {
              if (!params.id) throw new Error("Desktop must have an ID");
              if (!params.elem) throw new Error("Desktop must be linked to an element");
              if (!params.taskbar) throw new Error("Desktop must be linked to a taskbar");
              this.id = params.id;
              this.elem = params.elem;
              this.taskbar = params.taskbar;
              this.x_next = 30;
              this.y_next = 30;
              this.z_next = 1000;
              this.max_panes = 32;
              this.panes = [];
              // TODO
              // this.first_load = true;
              // this.user = "";
              this.restore();
            }

            createPane(pane_options) {
              if (this.panes.length > this.max_panes) {
                this.reset();
                return;
              }
              pane_options.desktop = this;
              pane_options.z = this.z_next;
              this.z_next += 1;
              if (!pane_options.transform && !pane_options.x && !pane_options.y) {
                pane_options.transform = `translate(${this.x_next}px, ${this.y_next}px)`;
                this.x_next += 30;
                this.y_next += 30;
                if (this.x_next > 500) this.x_next = this.x_next % 100;
                if (this.y_next > 500) this.y_next = this.y_next % 100;
              }
              // Create pane
              const pane = new Pane(pane_options);
              this.panes.push(pane);
              this.bringToFront(pane.target);
            }

            // Closes all panes matching a name
            closePanes(name) {
              const to_remove = this.panes.filter(p => p.name === name);
              if (to_remove) {
                // this.panes = this.panes.filter(p => p.name !== name);
                // this.save();
                // this.elem.removeChild(pane.target);
                // if (pane.taskbar_button) this.taskbar.removeChild(pane.taskbar_button);
                to_remove.forEach(p => p.close());
              } else {
                throw new Error(`No panes with ${name} to close`);
              }
            }

            bringToFront(pane_target) {
              const idx = this.panes.findIndex(p => p.target === pane_target);
              if (idx < 0) return;
              const pane = this.panes[idx]
              const pane_z_old = pane.z;
              // Find all panes with z-index > pane_z_old and decrement them
              this.panes.forEach(p => {
                p.setFocused(false);
                if (p.z > pane_z_old) p.setZ(p.z - 1);
              })
              // Set new active pane to top
              pane.setFocused(true);
              pane.setZ(this.z_next - 1);
            }

            markAllUnfocused() {
              this.panes.forEach(p => p.setFocused(false));
            }

            save() {
              localStorage.setItem(`desktop-${this.id}`, JSON.stringify(this.panes));
            }

            restore() {
              const saved_panes = JSON.parse(localStorage.getItem(`desktop-${this.id}`));
              if (!saved_panes) return;
              if (saved_panes.length > this.max_panes) {
                this.reset();
                return;
              }
              saved_panes.forEach(saved_pane => this.createPane(saved_pane))
            }

            reset() {
              localStorage.removeItem(`desktop-${this.id}`);
              window.location.reload();
            }

            createAlertPane(title, content) {
              const elem = `
                <div class="d-flex flex-row user-select-none">
                  <div class="m-2">
                    <img class="flex-shrink-0" src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/msg_error-0.png">
                  </div>
                  <div class="m-2">
                    <p>
                      ${content}
                    </p>
                  </div>
                </div>
                <div class="d-flex flex-row justify-content-center">
                  <button class="btn btn-sm btn-primary" x-ref="close">
                    <span>OK</span>
                  </button>
                </div>
              `
              this.createPane({
                name: "alert",
                title: title,
                taskbar_title: "Error",
                initial_body_elem: elem,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/msg_error-0.png",
                hide_minimize: true,
                hide_maximize: true,
                hide_close: false,
                disable_resize: true,
                transform: "center",
              });
            }

            createLoginPane() {
              const elem = `
                {% with form = Forms.auth.LoginForm() %}
                <form action="/login" method="post" accept-charset="utf-8" autocomplete="off" class="pb-2 user-select-none" @submit.prevent="desktop.doLoginForm($event)">
                  <div class="d-flex flex-row">
                    <div class="px-4 py-1">
                      <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/key_win_alt-2.png" width="64" height="64">
                    </div>
                    <div class="d-flex flex-column">
                      <p>
                        Type a user name and password to log on to UIUCTF 2023.
                      </p>
                      <div class="row">
                        <div class="col-4">
                          {{ form.name.label(class="form-label") }}
                        </div>
                        <div class="col-8">
                          {{ form.name(class="form-control", value=name) }}
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-4">
                          {{ form.password.label(class="form-label") }}
                        </div>
                        <div class="col-8">
                          {{ form.password(class="form-control", value=password) }}
                        </div>
                      </div>
                      <div>
                        <a class="font-xsmall" href="{{ url_for('auth.reset_password') }}">
                          Forgot your password?
                        </a>
                      </div>
                    </div>
                    <div class="d-flex flex-column pl-4">
                      <!-- {{ form.submit(class="btn btn-sm btn-primary") }} -->
                      <button class="btn btn-sm btn-block btn-primary" id="_submit" name="_submit" value="Submit">
                        <span>OK</span>
                      </button>
                      <button class="btn btn-sm btn-block btn-primary" disabled>
                        <span>Cancel</span>
                      </button>
                    </div>
                  </div>
                  {{ form.nonce() }}
                </form>
                {% endwith %}
              `;

              this.createPane({
                name: "login",
                title: "Welcome to UIUCTF 2023",
                taskbar_title: "Log In",
                initial_body_elem: elem,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/key_win-1.png",
                hide_minimize: true,
                hide_maximize: true,
                hide_close: false,
                disable_resize: true,
                transform: "center",
              });
            }

            createInfoPane() {
              const elem = `<div x-data="{selected: 'about'}"><h5>Welcome to <b>UIUCTF 2023</b></h5>
                            <div class="d-flex mt-3 flex-column">
                                <div class="d-flex flex-row">
                                    
                                    <div class="info-panel d-flex flex-column p-3 w-100">
                                        <template x-if="selected == 'about'">
                                            <div>
                                              <div class="d-flex flex-row align-items-center">
                                                  <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/tip.png" alt="">
                                                  <p class="font-weight-bold ml-2 mt-2">Did you know...</p>
                                              </div>
                                              <p>We have a <a href="https://discord.gg/9x2DBQXf96" target="_blank" rel="noopener noreferrer"> Discord server!</a></p>
                                            </div>
                                        </template>
                                        <template x-if="selected == 'when'">
                                          <div>
                                            <p>
                                            UIUCTF 2023 will be held Sat, 01 July 2023, 00:00 UTC — Mon, 03 July 2023, 00:00 UTC.
                                            </p>
                                            <!-- https://codepen.io/harsh/pen/KKdEVPV -->
                                            <div x-data="timer((window.init.end !== null) ? window.init.end * 1000 : window.init.start * 1000)">
                                              <h1 x-text="\`\${time().days}d:\${time().hours}h:\${time().minutes}m:\${time().seconds}s\`"></h1>
                                            </div>
                                          </div>
                                        </template>
                                        <template x-if="selected == 'prizes'">
                                            <div>
                                              <p> As Gill Bates once said, 5.736K ought to be enough for anybody.<br>
                                                That's why we are distributing exactly that much money!</p>
                                              <ul>
                                                <li>First Place - $2048</li>
                                                <li>Second Place - $1024</li>
                                                <li>Third Place - $512</li>
                                                <li>4th / 5th Place - $256</li>
                                                <li>6th - 10th Place - $128</li>
                                                <li>Writeup Prize Money - $1000</li>
                                              </ul>
                                            </div>
                                        </template>
                                        <template x-if="selected == 'sponsors'">
                                            <div>
                                              <p>
                                                  SIGPwny thanks its UIUCTF 2023 sponsors:
                                              </p>
                                              <div class="row">
                                                  <div class="col-6 mb-2">
                                                      <img src="/themes/uiuctf-2023-ctfd-theme/static/img/sponsor/battelle-blue.png" class="img-fluid" alt="">
                                                  </div>
                                                  <div class="col-6 mb-2">
                                                      <img src="/themes/uiuctf-2023-ctfd-theme/static/img/sponsor/zellic2.png" class="img-fluid" alt="">
                                                  </div>
                                                  <div class="col-6 mb-2">
                                                      <img src="/themes/uiuctf-2023-ctfd-theme/static/img/sponsor/trail-of-bits.png" class="img-fluid" alt="">
                                                  </div>
                                                  <div class="col-6 mb-2">
                                                      <a href="https://davidan.dev"><img src="https://davidan.dev/logo.png" class="img-fluid" alt=""></a>
                                                  </div>
                                                  <div class="col-6 mb-2">
                                                      <img src="/themes/uiuctf-2023-ctfd-theme/static/img/sponsor/google-cloud.png" class="img-fluid" alt="">
                                                      <p>Infra sponsored by <a href="https://goo.gle/ctfsponsorship" target="_blank" rel="noopener noreferrer">goo.gle/ctfsponsorship</a></p>
                                                  </div>
                                              </div>
                                            </div>
                                            </template>
                                        <template x-if="selected == 'team'">
                                            <div class="d-flex flex-column">
                                                <p>Meet the UIUCTF 2023 Team!!</p>
                                                <div class="row" x-data="{people: [
                                                    { name:'Pete Stenger', img:'https://avatars.githubusercontent.com/u/13869303', href:'https://github.com/reteps' },
                                                    { name:'Richard Liu', img:'https://avatars.githubusercontent.com/u/9328196', href:'https://github.com/richyliu' },
                                                    { name:'Hassam Uddin', img:'https://avatars.githubusercontent.com/u/13320947', href:'https://hassamuddin.com' },
                                                    { name:'YiFei Zhu', img:'https://lh3.googleusercontent.com/a-/ACB-R5SiFvHe6qP5yi3wJVNMUQqolSc-SRIl_ncQvhC_', href:'https://github.com/zhuyifei1999' },
                                                    { name:'kuilin', img:'https://kuilin.net/profile_upscaled.png', href:'https://kuilin.net/' },
                                                    { name:'David An', img:'https://davidan.dev/dave.jpeg', href:'https://davidan.dev' },
                                                    { name:'Ellie Popoca', img:'https://i.imgur.com/jVsQDUP.gif', href:'https://www.linkedin.com/in/elliepopoca' },
                                                    { name:'Pomona Carrington-Hoekstra', img:'https://avatars.githubusercontent.com/u/86129353' },
                                                    { name:'George Huebner', img:'https://avatars.githubusercontent.com/u/44840644', href:'https://github.com/Feyorsh' },
                                                    { name:'Joseph Ravichandran', img:'https://i.imgur.com/XOk7y7X.jpg', href:'https://twitter.com/0xjprx' },
                                                    { name:'Minh Duong', img:'https://avatars.githubusercontent.com/u/35712968', href:'https://whitehoodhacker.net/' },
                                                    { name:'Anakin Dey', img:'https://avatars.githubusercontent.com/spamakin', href:'https://www.anakin-dey.com/' },
                                                    { name:'Nitya Sunkad', img:'https://avatars.githubusercontent.com/u/52294194?v=4', href:'https://www.linkedin.com/in/nsunkad' },
                                                    { name:'Anusha Ghosh', img:'https://avatars.githubusercontent.com/u/35054976' }
                                                ]}">
                                                  <template x-for="person in people">
                                                    <div class="col-6 col-md-4 col-lg-3 d-flex align-items-center flex-column mb-2">
                                                        <img x-bind:src="person.img" class="img-fluid" alt="">
                                                        <a x-bind:href="person.href">
                                                            <span class="font-xsmall mt-1" x-text="person.name"></span>
                                                        </a>
                                                    </div>
                                                  </template>

                                                </div>
                                            </div>
                                          </template>
                                            
                                    </div>
                                <div class="d-flex flex-column pl-2">
                                    <button :class="\`btn btn-sm mb-1 btn-primary \${selected == 'about' ? 'border-dark' : ''}\`" type="button" @click="selected = 'about'"><span
                                        class="btn-text">About</span></button>
                                    <button :class="\`btn btn-sm mb-1 btn-primary \${selected == 'when' ? 'border-dark' : ''}\`" type="button" @click="selected = 'when'"><span
                                        class="btn-text">When</span></button>
                                        <button :class="\`btn btn-sm mb-1 btn-primary \${selected == 'prizes' ? 'border-dark' : ''}\`" type="button" @click="selected = 'prizes'"><span
                                            class="btn-text">Prizes</span></button>
                                    <button :class="\`btn btn-sm mb-1 btn-primary \${selected == 'sponsors' ? 'border-dark' : ''}\`" type="button" @click="selected = 'sponsors'"><span
                                        class="btn-text">Sponsors</span></button>
                                        <button :class="\`btn btn-sm mb-1 btn-primary \${selected == 'team' ? 'border-dark' : ''}\`" type="button" @click="selected = 'team'"><span
                                            class="btn-text">Team</span></button>
                                        </div>
                                    </div>
                                <div class="d-flex flex-row mt-2">
                                    <div class="form-check">
                                    <label class="form-check-label">
                                        <input class="form-check-input" type="checkbox">
                                        <span class="form-check-x"></span>
                                        <span class="form-check-sign"></span>
                                        <span class="font-xsmall">
                                            Show this Welcome Screen next time you start Windows
                                        </span>
                                    </label>
                                </div></div>`
              this.createPane({
                name: "info",
                title: "Info for UIUCTF 2023",
                taskbar_title: "Info",
                initial_body_elem: elem,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/help_book_big-1.png",
                hide_minimize: true,
                hide_maximize: true,
                hide_close: false,
                width: "600px",
                height: "400px",
                transform: "center",
              });
            }

            createRegisterPane() {
              const elem = `
              {% include "components/errors.html" %}
              {% with form = Forms.auth.RegistrationForm() %}

                {% from "macros/forms.html" import render_extra_fields %}

                <form method="post" accept-charset="utf-8" autocomplete="off" role="form">

                  <div class="row">
                    <div class="col-4">
                      <img class="img-fluid sidebar-img" src="/themes/uiuctf-2023-ctfd-theme/static/img/register-sidebar.jpg">
                    </div>
                    <div class="col-8 pt-2">
                      <p> Enter the basic information for the new user. </p>

                      <div class="row px-2 my-1">
                        <div class="col-3">
                          <b>{{ form.name.label(class="form-label") }}</b>
                        </div>
                        <div class="col d-flex flex-column">
                          {{ form.name(class="form-control", value=name) }}
                          <small class="font-xsmall text-muted">
                            Your username on the site
                          </small>
                        </div>
                      </div>
                      <div class="row px-2 my-1">
                        <div class="col-3">
                          <b>{{ form.email.label(class="form-label") }}</b>
                        </div>
                        <div class="col d-flex flex-column">
                          {{ form.email(class="form-control", value=email) }}
                          <small class="font-xsmall text-muted">
                            Never shown to the public
                          </small>
                        </div>
                      </div>
                      <div class="row px-2 my-1">
                        <div class="col-3">
                          <b>{{ form.password.label(class="form-label") }}</b>
                        </div>
                        <div class="col d-flex flex-column">
                          {{ form.password(class="form-control", value=password) }}
                          <small class="font-xsmall text-muted">
                            Password used to log into your account
                          </small>
                        </div>
                      </div>
                      <div class="row">
                        <p><br><br>To continue, click Next.</p>
                      </div>
                      {{ form.nonce() }}

                      {{ render_extra_fields(form.extra) }}
                    </div>
                  </div>
                  <hr class="py-0 my-0">
                  <div class="row my-3 px-2">
                    <div class="d-flex flex-row justify-content-end">
                      <button class="btn btn-md btn-primary" disabled>
                        <span>< Back</span>
                      </button>
                      <button class="btn btn-md btn-primary" id="_submit" name="_submit" value="Submit">
                        <span>Next ></span>
                      </button>
                    </div>
                  </div>

                  {% if Configs.tos_or_privacy %}
                    <div class="row py-2">
                      <div class="col-md-12 text-center">
                        <small class="text-muted text-center">
                          By registering, you agree to the
                          <a href="{{ Configs.privacy_link }}" rel="noopener" target="_blank">privacy policy</a>
                          and <a href="{{ Configs.tos_link }}" rel="noopener" target="_blank">terms of service</a>
                        </small>
                      </div>
                    </div>
                  {% endif %}
                </form>
              {% endwith %}
              `;

              this.createPane({
                name: "register",
                title: "Register for UIUCTF 2023",
                taskbar_title: "Register",
                initial_body_elem: elem,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/msagent-1.png",
                hide_close: false,
                width: "600px",
                height: "400px",
                transform: "center",
              });
            }
            async createScoreboardPane() {
              const elem = `
              {% include "components/errors.html" %}

              <div id="score-graph" class="d-flex align-items-center" x-data="ScoreboardDetail" x-ref="scoregraph">
                <div class="col-md-12 text-center">
                  <i class="fas fa-circle-notch fa-spin fa-3x fa-fw spinner"></i>
                </div>
              </div>

              {% cache 60, CacheKeys.PUBLIC_SCOREBOARD_TABLE %}
                {% if scoreboard_standings %}

                  <div id="scoreboard" class="row">
                    <div class="col-md-12">
                      <table class="table table-striped">
                        <thead>
                        <tr>
                          <td style="width: 10px"><b>Place</b></td>
                          <td><b>{{ get_mode_as_word(capitalize=True) }}</b></td>
                          <td><b>Score</b></td>
                        </tr>
                        </thead>

                        <tbody>
                        {% for standing in scoreboard_standings %}
                          <tr>
                            <th scope="row" class="text-center">{{ loop.index }}</th>
                            <td>
                              <a href="{{ generate_account_url(standing.account_id) }}">
                                {{ standing.name | truncate(50) }}

                                {% if standing.oauth_id %}
                                  {% if Configs.user_mode == 'teams' %}
                                    <a href="https://majorleaguecyber.org/t/{{ standing.name }}">
                                      <span class="badge bg-primary ms-2">Official</span>
                                    </a>
                                  {% elif Configs.user_mode == 'users' %}
                                    <a href="https://majorleaguecyber.org/u/{{ standing.name }}">
                                      <span class="badge bg-primary ms-2">Official</span>
                                    </a>
                                  {% endif %}
                                {% endif %}
                              </a>
                            </td>
                            <td>{{ standing.score }}</td>
                          </tr>
                        {% endfor %}
                        </tbody>

                      </table>
                    </div>
                  </div>

                {% endif %}
              {% endcache %}
              `
              this.createPane({
                name: "scoreboard",
                title: "Scoreboard",
                taskbar_title: "Scoreboard",
                initial_body_elem: elem,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/chart1-1.png",
                width: "600px",
                height: "400px",
              });
            }

            async createSettingsPane() {
              const elem = `<div class="row">
{% from "macros/forms.html" import render_extra_fields %}
<div class="col-md-3 offset-md-1 mb-3 mb-md-0">
  <div class="nav flex-column nav-pills" role="tablist">
    <button
        class="nav-link active" id="settings-profile-tab" data-bs-toggle="pill"
        data-bs-target="#profile" role="tab"
    >Profile
    </button>
    <button
        class="nav-link" id="settings-tokens-tab" data-bs-toggle="pill" data-bs-target="#tokens"
        role="tab"
    >Access Tokens
    </button>
  </div>
</div>

<div class="col-md-8">
  <div class="tab-content" id="v-pills-tabContent">
    <div class="tab-pane fade show active" id="profile" role="tabpanel">
      {% include "components/errors.html" %}

      {% with form = Forms.self.SettingsForm(country=settings_country) %}
        <form
            method="post" accept-charset="utf-8" autocomplete="off" role="form"
            x-data="SettingsForm"
            @submit.prevent="updateProfile()"
            class="form-horizontal"
        >

          <div class="mb-3">
            <b>{{ form.name.label(class="form-label") }}</b>
            {{ form.name(class="form-control", value=settings_name) }}
          </div>

          <div class="mb-3">
            <b>{{ form.email.label(class="form-label") }}</b>
            {{ form.email(class="form-control", value=settings_email) }}
          </div>

          <hr>

          <div class="mb-3">
            <b>{{ form.confirm.label(class="form-label") }}</b>
            {{ form.confirm(class="form-control") }}
          </div>
          <div class="mb-3">
            <b>{{ form.password.label(class="form-label") }}</b>
            {{ form.password(class="form-control") }}
          </div>

          <hr>

          <div class="mb-3">
            <b>{{ form.affiliation.label(class="form-label") }}</b>
            {{ form.affiliation(class="form-control", value=settings_affiliation or "") }}
          </div>
          <div class="mb-3">
            <b>{{ form.website.label(class="form-label") }}</b>
            {{ form.website(class="form-control", value=settings_website or "") }}
          </div>
          <div class="mb-3">
            <b>{{ form.country.label(class="form-label") }}</b>
            {{ form.country(class="form-control form-select", value=settings_country) }}
          </div>

          <hr>

          {{ render_extra_fields(form.extra) }}

          <div id="results" class="mb-3">
            <div
                class="alert alert-success alert-dismissible submit-row" role="alert"
                x-cloak="success" x-show="success"
            >
              <strong>Success!</strong>
              Your profile has been updated
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
              </button>
            </div>


            <template x-for="(msg, idx) in errors" :key="idx">
              <div class="alert alert-danger alert-dismissible" role="alert">
                <span class="sr-only">Error:</span>
                <span x-text="msg"></span>
                <button
                    type="button" class="btn-close" data-bs-dismiss="alert"
                    aria-label="Close"
                >
                </button>
              </div>
            </template>
          </div>

          <div class="mb-3">
            {{ form.submit(class="btn btn-primary float-end px-4") }}
          </div>
        </form>
      {% endwith %}
    </div>

    <div class="tab-pane fade" id="tokens" role="tabpanel">

      {% with form = Forms.self.TokensForm() %}
        <form method="POST" x-data="TokensForm" @submit.prevent="generateToken()" class="mb-3">
          <div class="modal fade" tabindex="-1" x-ref="tokenModal">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">API Key Generated</h5>
                  <button
                      type="button" class="btn-close" data-bs-dismiss="modal"
                      aria-label="Close"
                  ></button>
                </div>

                <div class="modal-body">
                  <p>Please copy your API Key, it won't be shown again!</p>

                  <div class="input-group mb-3">
                    <input
                        type="text" class="form-control bg-white" x-ref="token"
                        x-model="token" readonly
                    >
                    <button
                        class="btn btn-outline-secondary px-3" type="button"
                        @click="copyToken()"
                    >
                      <i class="fas fa-clipboard"></i>
                    </button>
                  </div>
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    Got it!
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <b>{{ form.expiration.label(class="form-label") }}</b>
            {{ form.expiration(class="form-control") }}
          </div>

          <div class="row">
            <div class="col">
              {{ form.submit(class="btn btn-block btn-primary float-end px-4") }}
            </div>
          </div>
        </form>
      {% endwith %}

      {% if settings_tokens %}
        <hr>

        <h4 class="text-center mt-3">Active Tokens</h4>

        {# This has to be wrapping the table modal, because div with modal will get pushed out
           of the table and alpine ref will not work #}
        <div x-data="Tokens">
          <div
              class="modal fade" x-ref="confirmModal" tabindex="-1" role="dialog"
              aria-modal="true"
          >
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Delete Token</h5>
                  <button
                      type="button" class="btn-close" data-bs-dismiss="modal"
                      aria-label="Close"
                  >
                  </button>
                </div>

                <div class="modal-body">
                  <p>Are you sure you want to delete this token?</p>
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                    No
                  </button>
                  <button
                      type="button" class="btn btn-primary" data-bs-dismiss="modal"
                      @click="deleteSelectedToken()"
                  >Yes
                  </button>
                </div>
              </div>
            </div>
          </div>

          <table class="table table-striped">
            <thead>
            <tr>
              <td class="text-center"><b>Created</b></td>
              <td><b>Expiration</b></td>
              <td><b>Delete</b></td>
            </tr>
            </thead>
            <tbody>
            {% for token in settings_tokens %}
              <tr x-ref="token-{{ token.id }}">
                <td class="text-center">
                  <span data-time="{{ token.created | isoformat }}"></span>
                </td>
                <td>
                  <span data-time="{{ token.expiration | isoformat }}"></span>
                </td>
                <td class="text-center">
                  <span
                      class="delete-token" role="button"
                      @click="deleteTokenModal({{ token.id }})">
                      <i class="cursor-pointer fas fa-times"></i>
                  </span>
                </td>
              </tr>
            {% endfor %}

            </tbody>
          </table>
        </div>
      {% endif %}

    </div>
  </div>
</div>
</div>`
              this.createPane({
                name: "settings",
                title: "Settings",
                taskbar_title: "Settings",
                initial_body_elem: elem,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/settings_gear-1.png",
                hide_close: false,
                width: "400px",
                height: "400px",
                transform: "translate(100px, 100px)",
              });
              
            }

            async closeAllPanes() {
              this.panes.forEach((pane) => {
                pane.close();
              });
            }

            async createChallengesPane() {
              // <div
              //   x-data="ChallengeBoard"
              //   @load-challenges.window="loadChallenges()"
              //   @load-challenge.window="loadChallenge($event.detail)"
              //   class="bg-white w-100 h-100 d-flex flex-column"
              // >
              const elem = `
                <div
                  x-data="ChallengeBoard"
                  class="bg-white w-100 h-100 d-flex flex-column"
                >
                  <div x-show="!loaded">
                    <div class="min-vh-50 d-flex align-items-center">
                      <div class="text-center w-100">
                        <i class="fas fa-circle-notch fa-spin fa-3x fa-fw spinner"></i>
                        <span class="sr-only">Loading...</span>
                      </div>
                    </div>
                  </div>

                  <div x-show="loaded">
                    <template x-for="(category, idx) in getCategories()" :key="idx">
                      <div class="pt-2">
                        <div class="category-header mb-3">
                          <p x-text="category"></p>
                        </div>
                        <hr />
                        <div style="display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(64px, 128px));">
                          <template x-for="(c, idx) in getChallenges(category)" :key="c.id">
                            <div
                              class="d-flex flex-column text-center mx-auto"
                              style="width: 64px;"
                              onclick="/* TODO: highlight icon/text (and remove when unclicked), on mobile open challenge */"
                              @dblclick="desktop.createChallengePane(c.id); event.stopPropagation();"
                            >
                              <img
                                :value="c.id"
                                x-show="!c.solved_by_me"
                                src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/computer-3.png"
                              >
                              <img
                                :value="c.id"
                                x-show="c.solved_by_me"
                                src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/check-0.png"
                              >
                              <div>
                                <p x-text="c.name"></p>
                                <span x-text="c.value"></span>
                              </div>
                            </div>
                          </template>
                        </div>

                      </div>
                    </template>
                  </div>
                </div>
              `
              this.createPane({
                name: "challenges",
                title: "Challenges",
                taskbar_title: "Challenges",
                initial_body_elem: elem,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/directory_open_file_mydocs_small-1.png",
                width: "600px",
                height: "400px",
              });
              // Display error if /challenges is not accessible
              window.CTFd.fetch("/api/v1/challenges")
                .then(response => response.json())
                .then(data => {
                  if (data.success) {
                    // window.CTFd.pages.challenges = data.data;
                    // window.dispatchEvent(new CustomEvent("load-challenges"));
                  } else {
                    desktop.createAlertPane(`403 Error`, `/challenges is not accessible.<br/><br/>Access is denied.`);
                  }
                })
            }

            async createChallengePane(id) {
              // TODO: add error message if challenge is not accessible
              const c = await window.CTFd.pages.challenges.getChallenge(id)
              if (!c) {
                desktop.createAlertPane(`403 Error`, `Challenge is not accessible.<br/><br/>Access is denied.`);
                return;
              }
              console.log(c);
              // Generate unique ID for tab selection
              let uniq, tab_id;
              do {
                uniq = Math.random().toString(16).slice(2);
                tab_id = `challenge_${id}_${uniq}`;
              } while (document.querySelector(`#${tab_id}`));
              const elem = `
<div class="d-flex flex-column h-100 w-100" id="${tab_id}" x-data="Challenge" x-init="id = ${c.id}">
  <ul class="nav nav-tabs user-select-none" id="${tab_id}_tablist" role="tablist">
    <li class="nav-item">
      <a
        class="nav-link active"
        id="${tab_id}_tab_challenge"
        data-bs-target="#${tab_id}_tabcontent_challenge"
        @click="showChallenge()"
      >
        Challenge
      </a>
    </li>
    <li class="nav-item">
      <a
        class="nav-link"
        id="${tab_id}_tab_solves"
        data-bs-target="#${tab_id}_tabcontent_solves"
        @click="showSolves()"
      >
        Solves
      </a>
    </li>
  </ul>
  <div class="tab-content flex-grow-1" id="${tab_id}_tabcontent">
    <div class="tab-pane show active" role="tabpanel"
      id="${tab_id}_tabcontent_challenge"
      aria-labelledby="${tab_id}_tabcontent_challenge"
    >
      <span>${c.name}</span>
      <p>${c.value} points</p>
      <p>${marked.parse(c.description)}</p>
      
    </div>
    <div class="tab-pane" role="tabpanel"
      id="${tab_id}_tabcontent_solves"
      aria-labelledby="${tab_id}_tabcontent_solves"
    >
      <p>
        Lorem ipsum dolor sit, amet consectetur adipisicing elit. Consequatur earum
        consequuntur accusamus reprehenderit quae sint, quia eligendi sed quidem
        neque omnis odit suscipit dolorum corrupti minima quas temporibus recusandae
        vel.
      </p>
    </div>
  </div>
</div>
              `
              this.createPane({
                name: "challenge",
                title: `${c.name}`,
                taskbar_title: `${c.name}`,
                initial_body_elem: elem,
                icon_path: "/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/computer-3.png",
                hide_maximize: true,
                disable_resize: true,
                transform: "center",
                width: "400px",
                height: "500px",
              });
            }

            async triggerLogout() {
              await fetch('/logout')
              Alpine.store('globals').user = null
            }

            async doLoginForm(event) {
              const response = await fetch('/login', {
                method: 'POST',
                body: new FormData(event.target)
              })
              const statusCode = response.status
              const html = await response.text()
    
              const matches = html.match(/role="alert"[\s\S]*?span>([\s\S]*?)<\/span>/m)
              const error = (matches && matches.length > 1) ? matches[1] : null
              if (error === null) {
                this.closePanes('login')
                if (statusCode === 403) {
                  this.createAlertPane("Login Error", "Login form expired. Please try again.");
                }
                location.reload();
              } else {
                this.createAlertPane('Login Error', error);
              }
            }
          }

          // Create Desktop
          desktop = new Desktop({
            id: "index3",
            elem: this.$refs.desktop,
            taskbar: this.$refs.taskbar
          });

          Alpine.store('globals').user = window.init.userName
        },


      }))
    })
  </script>
{% endblock head %}
<!-- End base -->

{% block page %}
  <div x-data="desktop" class="min-vh-100 d-flex flex-column bg-secondary">
    <!-- Desktop -->
    <main x-ref="desktop" class="d-flex flex-grow-1 w-100 flex-column">

    </main>

    <!-- Taskbar -->
    <footer class="d-flex position-relative">
      <nav class="navbar navbar-main navbar-expand-lg navbar-dark justify-content-between navbar-footer taskbar">
        <ul x-ref="taskbar" class="navbar-nav d-flex flex-row">
          <li class="nav-item start-button" @click.away="$store.globals.show_start = false">
            <div class="start-menu-container">
              <div class="start-menu" x-show="$store.globals.show_start" style="display: none;">
                <div class="logo-bar">
                  <img src="/themes/uiuctf-2023-ctfd-theme/static/img/start-menu-logo-sideways.png" />
                </div>
                <div class="main-options">
                  <div :class="$store.globals.user === null ? 'pe-none item-disabled' : ''" @click="desktop.createChallengesPane()">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/directory_open_file_mydocs_small-1.png" />
                    <span>
                      Challenges
                    </span>
                  </div>
                  <div :class="$store.globals.user === null ? 'pe-none item-disabled' : ''" @click="desktop.createScoreboardPane()">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/chart1-1.png" />
                    <span>
                      Scoreboard
                    </span>
                  </div>
                  <div :class="$store.globals.user === null ? 'pe-none item-disabled' : ''">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/address_book_user.png" />
                    <span>
                      Users
                    </span>
                  </div>
                  <div :class="$store.globals.user === null ? 'pe-none item-disabled' : ''">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/address_book_users.png" />
                    <span>
                      Teams
                    </span>
                  </div>
                  <div style="border-bottom: 1px solid #808080"  @click="desktop.createInfoPane()">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/help_book_big-1.png" />
                    <span>
                      Info
                    </span>
                  </div>
                  <div x-show="$store.globals.user !== null"  style="border-top: 1px solid #ffffff" @click="desktop.createSettingsPane()"">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/settings_gear-1.png" />
                    <span>
                      Settings
                    </span>
                  </div>
                  <div x-show="$store.globals.user !== null" @click="desktop.triggerLogout()">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/key_win-1.png" />
                    <span x-text="'Log out...'">
                    </span>
                  </div>
                  <div x-show="$store.globals.user === null" @click="desktop.createRegisterPane()" style="border-top: 1px solid #ffffff">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/msagent-1.png" />
                    <span>Register</span>
                  </div>
                  <div x-show="$store.globals.user === null" @click="desktop.createLoginPane()">
                    <img src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/key_win-1.png" />
                    <span x-text="'Log in...'">
                    </span>
                  </div>
                </div>
              </div>
            </div>
            <a class="nav-link d-flex flex-row font-weight-bold" role="button" :class="{ 'pane-focused': $store.globals.show_start === true }" @click="desktop.markAllUnfocused(); $store.globals.show_start = !$store.globals.show_start">
              <img class="taskbar-icon" src="/themes/uiuctf-2023-ctfd-theme/static/img/uiuctf-2023-pwny.svg" />
              <div>Start</div>
            </a>
          </li>
        </ul>
        <div class="d-flex flex-row align-items-center">
          <div class="mr-1 cursor-pointer font-xsmall d-flex flex-row" @click="desktop.closeAllPanes();"><div class="pt-1">Close All</div><img class="pl-1" src="/themes/uiuctf-2023-ctfd-theme/static/img/win98-icons/recycle_bin_full-1.png" /></div>
          <div id="time" class="time text-center">12:00 AM</div>
        </div>
      </nav>
    </footer>
  </div>
{% endblock %}

{% block scripts %}
  {{ Assets.js("assets/js/desktop.js") }}
  <script type="text/javascript">
    function refreshTime() {
      const time = new Date().toLocaleTimeString([], {hour: "numeric", minute:'2-digit'});
      document.getElementById("time").innerText = time;
    }
    if (document.getElementById("time")) {
      refreshTime();
      setInterval(refreshTime, 5000)
    }
  </script>
{% endblock %}
